
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Chapter 9 – Unsupervised Learning &#8212; Data Science Foundation in Python</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://jads-nl.github.io/data-science-foundation-curriculum/handson-ml2/original/09_unsupervised_learning.html" />
    <link rel="shortcut icon" href="../../_static/favicon-32x32.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Chapter 10 – Introduction to Artificial Neural Networks with Keras" href="10_neural_nets_with_keras.html" />
    <link rel="prev" title="Chapter 8 – Dimensionality Reduction" href="08_dimensionality_reduction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/jads-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Data Science Foundation in Python</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Why this JupyterBook?
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Statistical Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../islr/introduction.html">
   Introduction to ISLRv2
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../islr/labs.html">
   Labs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_02.3_introduction.html">
     Lab 2.3: Introduction to Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_03.6_linear_regression.html">
     Lab 3.6: Linear Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_04.7_classification_methods.html">
     Lab 4.7: Classification Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_05.3_cross_validation_and_the_bootstrap.html">
     Lab 5.3: Cross-Validation and the Bootstrap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_06.5.1_subset_selection_methods.html">
     Lab 6.5.1: Subset Selection Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_06.5.2_ridge_regression_and_the_lasso.html">
     Lab 6.5.2: Ridge Regression and the Lasso
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_06.5.3_pcr_and_pls_regression.html">
     Lab 6.5.3: PCR and PLS Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_07.8_non_linear_modelling.html">
     Lab 7.8: Non-linear Modeling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_08.3_decision_trees.html">
     Lab 8.3: Decision Trees
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_09.6_support_vector_machines.html">
     Lab 9.6: Support Vector Machines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_10.9.2_multilayer_network_on_mnist_digit_data.html">
     Lab 10.9.2: A Multilayer Network on the MNIST Digit Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_10.9.3_convolutional_neural_networks.html">
     Lab 10.9.3: Convolutional Neural Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_10.9.5_imdb_document_classification.html">
     Lab 10.9.5: IMDb Document Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_10.9.6_recurrent_neural_networks.html">
     Lab 10.9.6: Recurrent Neural Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../islr/labs/lab_12.5_unsupervised_learning.html">
     Lab 12.5: Unsupervised Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../islr/exercises.html">
   Exercises
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter2/index.html">
     Chapter 2
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise1.html">
       Exercise 2.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise2.html">
       Exercise 2.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise3.html">
       Exercise 2.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise4.html">
       Exercise 2.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise5.html">
       Exercise 2.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise6.html">
       Exercise 2.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise7.html">
       Exercise 2.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise8.html">
       Exercise 2.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise9.html">
       Exercise 2.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter2/exercise10.html">
       Exercise 2.10
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter3/index.html">
     Chapter 3
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise1.html">
       Exercise 3.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise2.html">
       Exercise 3.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise3.html">
       Exercise 3.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise4.html">
       Exercise 3.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise5.html">
       Exercise 3.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise6.html">
       Exercise 3.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise7.html">
       Exercise 3.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise8.html">
       Exercise 3.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise9.html">
       Exercise 3.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise10.html">
       Exercise 3.10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise11.html">
       Exercise 3.11
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise12.html">
       Exercise 3.12
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise13.html">
       Exercise 3.13
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise14.html">
       Exercise 3.14
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter3/exercise15.html">
       Exercise 3.15
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter4/index.html">
     Chapter 4
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise1.html">
       Exercise 4.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise2.html">
       Exercise 4.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise3.html">
       Exercise 4.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise4.html">
       Exercise 4.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise5.html">
       Exercise 4.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise6.html">
       Exercise 4.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise7.html">
       Exercise 4.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise8.html">
       Exercise 4.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise9.html">
       Exercise 4.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise10.html">
       Exercise 10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise11.html">
       Exercise 11
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise12.html">
       Exercise 12
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise13.html">
       Exercise 4.13
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise14.html">
       Exercise 4.11
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise15.html">
       Exercise 4.12
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter4/exercise16.html">
       Exercise 4.16
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter5/index.html">
     Chapter 5
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise1.html">
       Exercise 5.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise2.html">
       Exercise 5.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise3.html">
       Problem 5.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise4.html">
       Exercise 5.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise5.html">
       Exercise 5.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise6.html">
       Exercise 5.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise7.html">
       Exercise 5.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise8.html">
       Exercise 5.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter5/exercise9.html">
       Exercise 5.9
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter6/index.html">
     Chapter 6
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise1.html">
       Exercise 6.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise2.html">
       Exercise 6.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise3.html">
       Exercise 6.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise4.html">
       Exercise 6.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise5.html">
       Exercise 6.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise6.html">
       Exercise 6.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise7.html">
       Exercise 6.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise8.html">
       Exercise 6.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise9.html">
       Exercise 6.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise10.html">
       Exercise 6.10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter6/exercise11.html">
       Exercise 6.11
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter7/index.html">
     Chapter 7
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise1.html">
       Exercise 7.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise2.html">
       Exercise 7.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise3.html">
       Exercise 7.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise4.html">
       Exercise 7.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise5.html">
       Exercise 7.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise6.html">
       Exercise 7.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise7.html">
       Exercise 7.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise8.html">
       Exercise 7.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise9.html">
       Exercise 7.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise10.html">
       Exercise 7.10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise11.html">
       Exercise 7.11
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter7/exercise12.html">
       Exercise 7.12
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter8/index.html">
     Chapter 8
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise1.html">
       Exercise 8.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise2.html">
       Exercise 8.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise3.html">
       Exercise 8.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise4.html">
       Exercise 8.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise5.html">
       Exercise 8.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise6.html">
       Exercise 8.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise7.html">
       Exercise 8.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise8.html">
       Exercise 8.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise9.html">
       Exercise 8.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise10.html">
       Exercise 8.10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise11.html">
       Exercise 8.11
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter8/exercise12.html">
       Exercise 8.12
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter9/index.html">
     Chapter 9
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise1.html">
       Exercise 9.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise2.html">
       Exercise 9.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise3.html">
       Exercise 9.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise4.html">
       Exercise 9.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise5.html">
       Exercise 9.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise6.html">
       Exercise 9.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise7.html">
       Exercise 9.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter9/exercise8.html">
       Exercise 9.8
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../islr/exercises/chapter12/index.html">
     Chapter 12
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
    <label for="toctree-checkbox-11">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise1.html">
       Exercise 12.1
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise2.html">
       Exercise 12.2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise3.html">
       Exercise 12.3
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise4.html">
       Exercise 12.4
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise5.html">
       Exercise 12.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise6.html">
       Exercise 12.6
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise7.html">
       Exercise 12.7
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise8.html">
       Exercise 10.8
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise9.html">
       Exercise 12.9
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise10.html">
       Exercise 12.10
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../islr/exercises/chapter12/exercise11.html">
       Exercise 12.11
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Hands-on Machine Learning in Python
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../introduction.html">
   Hands-on Machine Learning with Aurélien Géron
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="01_the_machine_learning_landscape.html">
     Chapter 1 – The Machine Learning landscape
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02_end_to_end_machine_learning_project.html">
     Chapter 2 – End-to-end Machine Learning project
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_classification.html">
     Chapter 3 – Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="04_training_linear_models.html">
     Chapter 4 – Training Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="05_support_vector_machines.html">
     Chapter 5 – Support Vector Machines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="06_decision_trees.html">
     Chapter 6 – Decision Trees
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="07_ensemble_learning_and_random_forests.html">
     Chapter 7 – Ensemble Learning and Random Forests
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="08_dimensionality_reduction.html">
     Chapter 8 – Dimensionality Reduction
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Chapter 9 – Unsupervised Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="10_neural_nets_with_keras.html">
     Chapter 10 – Introduction to Artificial Neural Networks with Keras
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="11_training_deep_neural_networks.html">
     Chapter 11 – Training Deep Neural Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="12_custom_models_and_training_with_tensorflow.html">
     Chapter 12 – Custom Models and Training with TensorFlow
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="13_loading_and_preprocessing_data.html">
     Chapter 13 – Loading and Preprocessing Data with TensorFlow
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="14_deep_computer_vision_with_cnns.html">
     Chapter 14 – Deep Computer Vision Using Convolutional Neural Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="15_processing_sequences_using_rnns_and_cnns.html">
     Chapter 15 – Processing Sequences Using RNNs and CNNs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="16_nlp_with_rnns_and_attention.html">
     Chapter 16 – Natural Language Processing with RNNs and Attention**
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="17_autoencoders_and_gans.html">
     Chapter 17 – Autoencoders and GANs**
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="18_reinforcement_learning.html">
     Chapter 18 – Reinforcement Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="19_training_and_deploying_at_scale.html">
     Chapter 19 – Training and Deploying TensorFlow Models at Scale
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../extra.html">
   Miscellaneous tips &amp; tricks
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="math_linear_algebra.html">
     Math primer - Linear Algebra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="math_differential_calculus.html">
     Math primer - Differential Calculus
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="extra_autodiff.html">
     Implementation of autodiff techniques
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="extra_gradient_descent_comparison.html">
     Comparison of Batch, Mini-Batch and Stochastic Gradient Descent
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data visualization with Altair
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../visualization/introduction.html">
   Data visualization with Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../visualization/introduction-to-interactive-data-visualization.html">
   Introduction to data visualization with Python
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../visualization/altair_get_started.html">
   Getting Started with Altair
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_introduction.html">
     Introduction to Altair
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_marks_encoding.html">
     Data Types, Graphical Marks, and Visual Encoding Channels
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_data_transformation.html">
     Data Transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_scales_axes_legends.html">
     Scales, Axes, and Legends
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_view_composition.html">
     Multi-View Composition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_interaction.html">
     Interaction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_cartographic.html">
     Cartographic Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../visualization/altair_debugging.html">
     Altair Debugging Guide
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Interpretable Machine Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../iml/introduction.html">
   Introduction to IML
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../iml/plot_partial_dependence.html">
     Partial Dependence and Individual Conditional Expectation Plots
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../iml/plot_permutation_importance.html">
     Permutation Importance vs Random Forest Feature Importance (MDI)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../iml/plot_permutation_importance_multicollinear.html">
     Permutation Importance with Multicollinear or Correlated Features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../iml/interpreting-machine-learning-models.html">
     IML with Pima Indians and the Titanic datasets
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Principles of time-series forecasting
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpp/introduction.html">
   Introduction to FPP3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpp/examples-time-series-forecasting-with-python.html">
   Examples of time-series forecasting with Python
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Natural language processing with spaCy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../nlp/introduction.html">
   Introduction to NLP with spaCy
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../nlp/dutch-restaurant-reviews.html">
   Dutch restaurant reviews
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../nlp/nlp-dutch-restaurant-reviews.html">
     Analyzing Dutch restaurant reviews
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../nlp/prepare-restoreviews-dataset.html">
     Fetch and prepare reviews
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../nlp/nlp-pipeline-example.html">
     Objective
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../nlp/language-detection-with-character-quadgrams.html">
     Extra: language detection with character quadgrams
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../nlp/nlp-model-sizes.html">
     Extra: plot of transformer model sizes
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/jads-nl/data-science-foundation-in-python/main?urlpath=tree/data_science_foundation_in_python/handson-ml2/original/09_unsupervised_learning.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/jads-nl/data-science-foundation-in-python/blob/main/data_science_foundation_in_python/handson-ml2/original/09_unsupervised_learning.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/jads-nl/data-science-foundation-in-python"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/jads-nl/data-science-foundation-in-python/issues/new?title=Issue%20on%20page%20%2Fhandson-ml2/original/09_unsupervised_learning.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/handson-ml2/original/09_unsupervised_learning.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 9 – Unsupervised Learning
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clustering">
   Clustering
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means">
     K-Means
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-k-means-algorithm">
       The K-Means Algorithm
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inertia">
       Inertia
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multiple-initializations">
       Multiple Initializations
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#centroid-initialization-methods">
       Centroid initialization methods
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accelerated-k-means">
       Accelerated K-Means
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mini-batch-k-means">
       Mini-Batch K-Means
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#finding-the-optimal-number-of-clusters">
       Finding the optimal number of clusters
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limits-of-k-means">
     Limits of K-Means
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-image-segmentation">
     Using Clustering for Image Segmentation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-preprocessing">
     Using Clustering for Preprocessing
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-semi-supervised-learning">
     Using Clustering for Semi-Supervised Learning
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbscan">
     DBSCAN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-clustering-algorithms">
     Other Clustering Algorithms
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spectral-clustering">
       Spectral Clustering
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#agglomerative-clustering">
       Agglomerative Clustering
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gaussian-mixtures">
   Gaussian Mixtures
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#anomaly-detection-using-gaussian-mixtures">
     Anomaly Detection Using Gaussian Mixtures
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#selecting-the-number-of-clusters">
     Selecting the Number of Clusters
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bayesian-gaussian-mixture-models">
     Bayesian Gaussian Mixture Models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-solutions">
   Exercise solutions
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#to-9">
     1. to 9.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cluster-the-olivetti-faces-dataset">
     10. Cluster the Olivetti Faces Dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-as-preprocessing-for-classification">
     11. Using Clustering as Preprocessing for Classification
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-gaussian-mixture-model-for-the-olivetti-faces-dataset">
     12. A Gaussian Mixture Model for the Olivetti Faces Dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-dimensionality-reduction-techniques-for-anomaly-detection">
     13. Using Dimensionality Reduction Techniques for Anomaly Detection
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chapter 9 – Unsupervised Learning</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 9 – Unsupervised Learning
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clustering">
   Clustering
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means">
     K-Means
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-k-means-algorithm">
       The K-Means Algorithm
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inertia">
       Inertia
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multiple-initializations">
       Multiple Initializations
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#centroid-initialization-methods">
       Centroid initialization methods
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accelerated-k-means">
       Accelerated K-Means
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mini-batch-k-means">
       Mini-Batch K-Means
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#finding-the-optimal-number-of-clusters">
       Finding the optimal number of clusters
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limits-of-k-means">
     Limits of K-Means
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-image-segmentation">
     Using Clustering for Image Segmentation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-preprocessing">
     Using Clustering for Preprocessing
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-for-semi-supervised-learning">
     Using Clustering for Semi-Supervised Learning
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbscan">
     DBSCAN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-clustering-algorithms">
     Other Clustering Algorithms
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spectral-clustering">
       Spectral Clustering
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#agglomerative-clustering">
       Agglomerative Clustering
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gaussian-mixtures">
   Gaussian Mixtures
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#anomaly-detection-using-gaussian-mixtures">
     Anomaly Detection Using Gaussian Mixtures
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#selecting-the-number-of-clusters">
     Selecting the Number of Clusters
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bayesian-gaussian-mixture-models">
     Bayesian Gaussian Mixture Models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-solutions">
   Exercise solutions
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#to-9">
     1. to 9.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cluster-the-olivetti-faces-dataset">
     10. Cluster the Olivetti Faces Dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-clustering-as-preprocessing-for-classification">
     11. Using Clustering as Preprocessing for Classification
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-gaussian-mixture-model-for-the-olivetti-faces-dataset">
     12. A Gaussian Mixture Model for the Olivetti Faces Dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-dimensionality-reduction-techniques-for-anomaly-detection">
     13. Using Dimensionality Reduction Techniques for Anomaly Detection
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="chapter-9-unsupervised-learning">
<h1>Chapter 9 – Unsupervised Learning<a class="headerlink" href="#chapter-9-unsupervised-learning" title="Permalink to this headline">#</a></h1>
<p><em>This notebook contains all the sample code in chapter 9.</em></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h1>
<p>First, let’s import a few common modules, ensure MatplotLib plots figures inline and prepare a function to save the figures. We also check that Python 3.5 or later is installed (although Python 2.x may work, it is deprecated so we strongly recommend you use Python 3 instead), as well as Scikit-Learn ≥0.20.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Python ≥3.5 is required
import sys
assert sys.version_info &gt;= (3, 5)

# Scikit-Learn ≥0.20 is required
import sklearn
assert sklearn.__version__ &gt;= &quot;0.20&quot;

# Common imports
import numpy as np
import os

# to make this notebook&#39;s output stable across runs
np.random.seed(42)

# To plot pretty figures
%matplotlib inline
import matplotlib as mpl
import matplotlib.pyplot as plt
mpl.rc(&#39;axes&#39;, labelsize=14)
mpl.rc(&#39;xtick&#39;, labelsize=12)
mpl.rc(&#39;ytick&#39;, labelsize=12)

# Where to save the figures
PROJECT_ROOT_DIR = &quot;.&quot;
CHAPTER_ID = &quot;unsupervised_learning&quot;
IMAGES_PATH = os.path.join(PROJECT_ROOT_DIR, &quot;images&quot;, CHAPTER_ID)
os.makedirs(IMAGES_PATH, exist_ok=True)

def save_fig(fig_id, tight_layout=True, fig_extension=&quot;png&quot;, resolution=300):
    path = os.path.join(IMAGES_PATH, fig_id + &quot;.&quot; + fig_extension)
    print(&quot;Saving figure&quot;, fig_id)
    if tight_layout:
        plt.tight_layout()
    plt.savefig(path, format=fig_extension, dpi=resolution)
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="clustering">
<h1>Clustering<a class="headerlink" href="#clustering" title="Permalink to this headline">#</a></h1>
<p><strong>Introduction – Classification <em>vs</em> Clustering</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.datasets import load_iris
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data = load_iris()
X = data.data
y = data.target
data.target_names
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;setosa&#39;, &#39;versicolor&#39;, &#39;virginica&#39;], dtype=&#39;&lt;U10&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(9, 3.5))

plt.subplot(121)
plt.plot(X[y==0, 2], X[y==0, 3], &quot;yo&quot;, label=&quot;Iris setosa&quot;)
plt.plot(X[y==1, 2], X[y==1, 3], &quot;bs&quot;, label=&quot;Iris versicolor&quot;)
plt.plot(X[y==2, 2], X[y==2, 3], &quot;g^&quot;, label=&quot;Iris virginica&quot;)
plt.xlabel(&quot;Petal length&quot;, fontsize=14)
plt.ylabel(&quot;Petal width&quot;, fontsize=14)
plt.legend(fontsize=12)

plt.subplot(122)
plt.scatter(X[:, 2], X[:, 3], c=&quot;k&quot;, marker=&quot;.&quot;)
plt.xlabel(&quot;Petal length&quot;, fontsize=14)
plt.tick_params(labelleft=False)

save_fig(&quot;classification_vs_clustering_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure classification_vs_clustering_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_8_1.png" src="../../_images/09_unsupervised_learning_8_1.png" />
</div>
</div>
<p>A Gaussian mixture model (explained below) can actually separate these clusters pretty well (using all 4 features: petal length &amp; width, and sepal length &amp; width).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.mixture import GaussianMixture
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_pred = GaussianMixture(n_components=3, random_state=42).fit(X).predict(X)
</pre></div>
</div>
</div>
</div>
<p>Let’s map each cluster to a class. Instead of hard coding the mapping (as is done in the book, for simplicity), we will pick the most common class for each cluster (using the <code class="docutils literal notranslate"><span class="pre">scipy.stats.mode()</span></code> function):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from scipy import stats

mapping = {}
for class_id in np.unique(y):
    mode, _ = stats.mode(y_pred[y==class_id])
    mapping[mode[0]] = class_id

mapping
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{1: 0, 2: 1, 0: 2}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_pred = np.array([mapping[cluster_id] for cluster_id in y_pred])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.plot(X[y_pred==0, 2], X[y_pred==0, 3], &quot;yo&quot;, label=&quot;Cluster 1&quot;)
plt.plot(X[y_pred==1, 2], X[y_pred==1, 3], &quot;bs&quot;, label=&quot;Cluster 2&quot;)
plt.plot(X[y_pred==2, 2], X[y_pred==2, 3], &quot;g^&quot;, label=&quot;Cluster 3&quot;)
plt.xlabel(&quot;Petal length&quot;, fontsize=14)
plt.ylabel(&quot;Petal width&quot;, fontsize=14)
plt.legend(loc=&quot;upper left&quot;, fontsize=12)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_15_0.png" src="../../_images/09_unsupervised_learning_15_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.sum(y_pred==y)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>145
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.sum(y_pred==y) / len(y_pred)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9666666666666667
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong>: the results in this notebook may differ slightly from the book. This is because algorithms can sometimes be tweaked a bit between Scikit-Learn versions.</p>
<section id="k-means">
<h2>K-Means<a class="headerlink" href="#k-means" title="Permalink to this headline">#</a></h2>
<p>Let’s start by generating some blobs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.datasets import make_blobs
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>blob_centers = np.array(
    [[ 0.2,  2.3],
     [-1.5 ,  2.3],
     [-2.8,  1.8],
     [-2.8,  2.8],
     [-2.8,  1.3]])
blob_std = np.array([0.4, 0.3, 0.1, 0.1, 0.1])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X, y = make_blobs(n_samples=2000, centers=blob_centers,
                  cluster_std=blob_std, random_state=7)
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_clusters(X, y=None):
    plt.scatter(X[:, 0], X[:, 1], c=y, s=1)
    plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
    plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 4))
plot_clusters(X)
save_fig(&quot;blobs_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure blobs_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_26_1.png" src="../../_images/09_unsupervised_learning_26_1.png" />
</div>
</div>
<p><strong>Fit and predict</strong></p>
<p>Let’s train a K-Means clusterer on this dataset. It will try to find each blob’s center and assign each instance to the closest blob:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import KMeans
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>k = 5
kmeans = KMeans(n_clusters=k, random_state=42)
y_pred = kmeans.fit_predict(X)
</pre></div>
</div>
</div>
</div>
<p>Each instance was assigned to one of the 5 clusters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_pred
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([4, 1, 0, ..., 3, 0, 1], dtype=int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_pred is kmeans.labels_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>And the following 5 <em>centroids</em> (i.e., cluster centers) were estimated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans.cluster_centers_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.20876306,  2.25551336],
       [-2.80389616,  1.80117999],
       [-1.46679593,  2.28585348],
       [-2.79290307,  2.79641063],
       [-2.80037642,  1.30082566]])
</pre></div>
</div>
</div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">KMeans</span></code> instance preserves the labels of the instances it was trained on. Somewhat confusingly, in this context, the <em>label</em> of an instance is the index of the cluster that instance gets assigned to:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans.labels_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([4, 1, 0, ..., 3, 0, 1], dtype=int32)
</pre></div>
</div>
</div>
</div>
<p>Of course, we can predict the labels of new instances:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_new = np.array([[0, 2], [3, 2], [-3, 3], [-3, 2.5]])
kmeans.predict(X_new)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 0, 3, 3], dtype=int32)
</pre></div>
</div>
</div>
</div>
<p><strong>Decision Boundaries</strong></p>
<p>Let’s plot the model’s decision boundaries. This gives us a <em>Voronoi diagram</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_data(X):
    plt.plot(X[:, 0], X[:, 1], &#39;k.&#39;, markersize=2)

def plot_centroids(centroids, weights=None, circle_color=&#39;w&#39;, cross_color=&#39;k&#39;):
    if weights is not None:
        centroids = centroids[weights &gt; weights.max() / 10]
    plt.scatter(centroids[:, 0], centroids[:, 1],
                marker=&#39;o&#39;, s=35, linewidths=8,
                color=circle_color, zorder=10, alpha=0.9)
    plt.scatter(centroids[:, 0], centroids[:, 1],
                marker=&#39;x&#39;, s=2, linewidths=12,
                color=cross_color, zorder=11, alpha=1)

def plot_decision_boundaries(clusterer, X, resolution=1000, show_centroids=True,
                             show_xlabels=True, show_ylabels=True):
    mins = X.min(axis=0) - 0.1
    maxs = X.max(axis=0) + 0.1
    xx, yy = np.meshgrid(np.linspace(mins[0], maxs[0], resolution),
                         np.linspace(mins[1], maxs[1], resolution))
    Z = clusterer.predict(np.c_[xx.ravel(), yy.ravel()])
    Z = Z.reshape(xx.shape)

    plt.contourf(Z, extent=(mins[0], maxs[0], mins[1], maxs[1]),
                cmap=&quot;Pastel2&quot;)
    plt.contour(Z, extent=(mins[0], maxs[0], mins[1], maxs[1]),
                linewidths=1, colors=&#39;k&#39;)
    plot_data(X)
    if show_centroids:
        plot_centroids(clusterer.cluster_centers_)

    if show_xlabels:
        plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
    else:
        plt.tick_params(labelbottom=False)
    if show_ylabels:
        plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
    else:
        plt.tick_params(labelleft=False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 4))
plot_decision_boundaries(kmeans, X)
save_fig(&quot;voronoi_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure voronoi_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_43_1.png" src="../../_images/09_unsupervised_learning_43_1.png" />
</div>
</div>
<p>Not bad! Some of the instances near the edges were probably assigned to the wrong cluster, but overall it looks pretty good.</p>
<p><strong>Hard Clustering <em>vs</em> Soft Clustering</strong></p>
<p>Rather than arbitrarily choosing the closest cluster for each instance, which is called <em>hard clustering</em>, it might be better measure the distance of each instance to all 5 centroids. This is what the <code class="docutils literal notranslate"><span class="pre">transform()</span></code> method does:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans.transform(X_new)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[2.88633901, 0.32995317, 2.9042344 , 1.49439034, 2.81093633],
       [5.84236351, 2.80290755, 5.84739223, 4.4759332 , 5.80730058],
       [1.71086031, 3.29399768, 0.29040966, 1.69136631, 1.21475352],
       [1.21567622, 3.21806371, 0.36159148, 1.54808703, 0.72581411]])
</pre></div>
</div>
</div>
</div>
<p>You can verify that this is indeed the Euclidian distance between each instance and each centroid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.linalg.norm(np.tile(X_new, (1, k)).reshape(-1, k, 2) - kmeans.cluster_centers_, axis=2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[2.88633901, 0.32995317, 2.9042344 , 1.49439034, 2.81093633],
       [5.84236351, 2.80290755, 5.84739223, 4.4759332 , 5.80730058],
       [1.71086031, 3.29399768, 0.29040966, 1.69136631, 1.21475352],
       [1.21567622, 3.21806371, 0.36159148, 1.54808703, 0.72581411]])
</pre></div>
</div>
</div>
</div>
<section id="the-k-means-algorithm">
<h3>The K-Means Algorithm<a class="headerlink" href="#the-k-means-algorithm" title="Permalink to this headline">#</a></h3>
<p>The K-Means algorithm is one of the fastest clustering algorithms, and also one of the simplest:</p>
<ul class="simple">
<li><p>First initialize <span class="math notranslate nohighlight">\(k\)</span> centroids randomly: <span class="math notranslate nohighlight">\(k\)</span> distinct instances are chosen randomly from the dataset and the centroids are placed at their locations.</p></li>
<li><p>Repeat until convergence (i.e., until the centroids stop moving):</p>
<ul>
<li><p>Assign each instance to the closest centroid.</p></li>
<li><p>Update the centroids to be the mean of the instances that are assigned to them.</p></li>
</ul>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">KMeans</span></code> class applies an optimized algorithm by default. To get the original K-Means algorithm (for educational purposes only), you must set <code class="docutils literal notranslate"><span class="pre">init=&quot;random&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">n_init=1</span></code>and <code class="docutils literal notranslate"><span class="pre">algorithm=&quot;full&quot;</span></code>. These hyperparameters will be explained below.</p>
<p>Let’s run the K-Means algorithm for 1, 2 and 3 iterations, to see how the centroids move around:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_iter1 = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=1,
                     algorithm=&quot;full&quot;, max_iter=1, random_state=0)
kmeans_iter2 = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=1,
                     algorithm=&quot;full&quot;, max_iter=2, random_state=0)
kmeans_iter3 = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=1,
                     algorithm=&quot;full&quot;, max_iter=3, random_state=0)
kmeans_iter1.fit(X)
kmeans_iter2.fit(X)
kmeans_iter3.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KMeans(algorithm=&#39;full&#39;, init=&#39;random&#39;, max_iter=3, n_clusters=5, n_init=1,
       random_state=0)
</pre></div>
</div>
</div>
</div>
<p>And let’s plot this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(10, 8))

plt.subplot(321)
plot_data(X)
plot_centroids(kmeans_iter1.cluster_centers_, circle_color=&#39;r&#39;, cross_color=&#39;w&#39;)
plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
plt.tick_params(labelbottom=False)
plt.title(&quot;Update the centroids (initially randomly)&quot;, fontsize=14)

plt.subplot(322)
plot_decision_boundaries(kmeans_iter1, X, show_xlabels=False, show_ylabels=False)
plt.title(&quot;Label the instances&quot;, fontsize=14)

plt.subplot(323)
plot_decision_boundaries(kmeans_iter1, X, show_centroids=False, show_xlabels=False)
plot_centroids(kmeans_iter2.cluster_centers_)

plt.subplot(324)
plot_decision_boundaries(kmeans_iter2, X, show_xlabels=False, show_ylabels=False)

plt.subplot(325)
plot_decision_boundaries(kmeans_iter2, X, show_centroids=False)
plot_centroids(kmeans_iter3.cluster_centers_)

plt.subplot(326)
plot_decision_boundaries(kmeans_iter3, X, show_ylabels=False)

save_fig(&quot;kmeans_algorithm_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure kmeans_algorithm_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_56_1.png" src="../../_images/09_unsupervised_learning_56_1.png" />
</div>
</div>
<p><strong>K-Means Variability</strong></p>
<p>In the original K-Means algorithm, the centroids are just initialized randomly, and the algorithm simply runs a single iteration to gradually improve the centroids, as we saw above.</p>
<p>However, one major problem with this approach is that if you run K-Means multiple times (or with different random seeds), it can converge to very different solutions, as you can see below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_clusterer_comparison(clusterer1, clusterer2, X, title1=None, title2=None):
    clusterer1.fit(X)
    clusterer2.fit(X)

    plt.figure(figsize=(10, 3.2))

    plt.subplot(121)
    plot_decision_boundaries(clusterer1, X)
    if title1:
        plt.title(title1, fontsize=14)

    plt.subplot(122)
    plot_decision_boundaries(clusterer2, X, show_ylabels=False)
    if title2:
        plt.title(title2, fontsize=14)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_rnd_init1 = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=1,
                         algorithm=&quot;full&quot;, random_state=2)
kmeans_rnd_init2 = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=1,
                         algorithm=&quot;full&quot;, random_state=5)

plot_clusterer_comparison(kmeans_rnd_init1, kmeans_rnd_init2, X,
                          &quot;Solution 1&quot;, &quot;Solution 2 (with a different random init)&quot;)

save_fig(&quot;kmeans_variability_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure kmeans_variability_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_60_1.png" src="../../_images/09_unsupervised_learning_60_1.png" />
</div>
</div>
</section>
<section id="inertia">
<h3>Inertia<a class="headerlink" href="#inertia" title="Permalink to this headline">#</a></h3>
<p>To select the best model, we will need a way to evaluate a K-Mean model’s performance. Unfortunately, clustering is an unsupervised task, so we do not have the targets. But at least we can measure the distance between each instance and its centroid. This is the idea behind the <em>inertia</em> metric:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>211.5985372581683
</pre></div>
</div>
</div>
</div>
<p>As you can easily verify, inertia is the sum of the squared distances between each training instance and its closest centroid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_dist = kmeans.transform(X)
np.sum(X_dist[np.arange(len(X_dist)), kmeans.labels_]**2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>211.5985372581684
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">score()</span></code> method returns the negative inertia. Why negative? Well, it is because a predictor’s <code class="docutils literal notranslate"><span class="pre">score()</span></code> method must always respect the “<em>greater is better</em>” rule.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans.score(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-211.5985372581683
</pre></div>
</div>
</div>
</div>
</section>
<section id="multiple-initializations">
<h3>Multiple Initializations<a class="headerlink" href="#multiple-initializations" title="Permalink to this headline">#</a></h3>
<p>So one approach to solve the variability issue is to simply run the K-Means algorithm multiple times with different random initializations, and select the solution that minimizes the inertia. For example, here are the inertias of the two “bad” models shown in the previous figure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_rnd_init1.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>219.8438540223319
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_rnd_init2.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>236.95563196978728
</pre></div>
</div>
</div>
</div>
<p>As you can see, they have a higher inertia than the first “good” model we trained, which means they are probably worse.</p>
<p>When you set the <code class="docutils literal notranslate"><span class="pre">n_init</span></code> hyperparameter, Scikit-Learn runs the original algorithm <code class="docutils literal notranslate"><span class="pre">n_init</span></code> times, and selects the solution that minimizes the inertia. By default, Scikit-Learn sets <code class="docutils literal notranslate"><span class="pre">n_init=10</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_rnd_10_inits = KMeans(n_clusters=5, init=&quot;random&quot;, n_init=10,
                              algorithm=&quot;full&quot;, random_state=2)
kmeans_rnd_10_inits.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KMeans(algorithm=&#39;full&#39;, init=&#39;random&#39;, n_clusters=5, random_state=2)
</pre></div>
</div>
</div>
</div>
<p>As you can see, we end up with the initial model, which is certainly the optimal K-Means solution (at least in terms of inertia, and assuming <span class="math notranslate nohighlight">\(k=5\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 4))
plot_decision_boundaries(kmeans_rnd_10_inits, X)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_76_0.png" src="../../_images/09_unsupervised_learning_76_0.png" />
</div>
</div>
</section>
<section id="centroid-initialization-methods">
<h3>Centroid initialization methods<a class="headerlink" href="#centroid-initialization-methods" title="Permalink to this headline">#</a></h3>
<p>Instead of initializing the centroids entirely randomly, it is preferable to initialize them using the following algorithm, proposed in a <a class="reference external" href="https://goo.gl/eNUPw6">2006 paper</a> by David Arthur and Sergei Vassilvitskii:</p>
<ul class="simple">
<li><p>Take one centroid <span class="math notranslate nohighlight">\(c_1\)</span>, chosen uniformly at random from the dataset.</p></li>
<li><p>Take a new center <span class="math notranslate nohighlight">\(c_i\)</span>, choosing an instance <span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span> with probability: <span class="math notranslate nohighlight">\(D(\mathbf{x}_i)^2\)</span> / <span class="math notranslate nohighlight">\(\sum\limits_{j=1}^{m}{D(\mathbf{x}_j)}^2\)</span> where <span class="math notranslate nohighlight">\(D(\mathbf{x}_i)\)</span> is the distance between the instance <span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span> and the closest centroid that was already chosen. This probability distribution ensures that instances that are further away from already chosen centroids are much more likely be selected as centroids.</p></li>
<li><p>Repeat the previous step until all <span class="math notranslate nohighlight">\(k\)</span> centroids have been chosen.</p></li>
</ul>
<p>The rest of the K-Means++ algorithm is just regular K-Means. With this initialization, the K-Means algorithm is much less likely to converge to a suboptimal solution, so it is possible to reduce <code class="docutils literal notranslate"><span class="pre">n_init</span></code> considerably. Most of the time, this largely compensates for the additional complexity of the initialization process.</p>
<p>To set the initialization to K-Means++, simply set <code class="docutils literal notranslate"><span class="pre">init=&quot;k-means++&quot;</span></code> (this is actually the default):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>KMeans()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KMeans()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>good_init = np.array([[-3, 3], [-3, 2], [-3, 1], [-1, 2], [0, 2]])
kmeans = KMeans(n_clusters=5, init=good_init, n_init=1, random_state=42)
kmeans.fit(X)
kmeans.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>211.62337889822362
</pre></div>
</div>
</div>
</div>
</section>
<section id="accelerated-k-means">
<h3>Accelerated K-Means<a class="headerlink" href="#accelerated-k-means" title="Permalink to this headline">#</a></h3>
<p>The K-Means algorithm can be significantly accelerated by avoiding many unnecessary distance calculations: this is achieved by exploiting the triangle inequality (given three points A, B and C, the distance AC is always such that AC ≤ AB + BC) and by keeping track of lower and upper bounds for distances between instances and centroids (see this <a class="reference external" href="https://www.aaai.org/Papers/ICML/2003/ICML03-022.pdf">2003 paper</a> by Charles Elkan for more details).</p>
<p>To use Elkan’s variant of K-Means, just set <code class="docutils literal notranslate"><span class="pre">algorithm=&quot;elkan&quot;</span></code>. Note that it does not support sparse data, so by default, Scikit-Learn uses <code class="docutils literal notranslate"><span class="pre">&quot;elkan&quot;</span></code> for dense data, and <code class="docutils literal notranslate"><span class="pre">&quot;full&quot;</span></code> (the regular K-Means algorithm) for sparse data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%timeit -n 50 KMeans(algorithm=&quot;elkan&quot;, random_state=42).fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>90.4 ms ± 612 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%timeit -n 50 KMeans(algorithm=&quot;full&quot;, random_state=42).fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>91.6 ms ± 171 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)
</pre></div>
</div>
</div>
</div>
<p>There’s no big difference in this case, as the dataset is fairly small.</p>
</section>
<section id="mini-batch-k-means">
<h3>Mini-Batch K-Means<a class="headerlink" href="#mini-batch-k-means" title="Permalink to this headline">#</a></h3>
<p>Scikit-Learn also implements a variant of the K-Means algorithm that supports mini-batches (see <a class="reference external" href="http://www.eecs.tufts.edu/~dsculley/papers/fastkmeans.pdf">this paper</a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import MiniBatchKMeans
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>minibatch_kmeans = MiniBatchKMeans(n_clusters=5, random_state=42)
minibatch_kmeans.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MiniBatchKMeans(n_clusters=5, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>minibatch_kmeans.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>211.93186531476786
</pre></div>
</div>
</div>
</div>
<p>If the dataset does not fit in memory, the simplest option is to use the <code class="docutils literal notranslate"><span class="pre">memmap</span></code> class, just like we did for incremental PCA in the previous chapter. First let’s load MNIST:</p>
<p><strong>Warning:</strong> since Scikit-Learn 0.24, <code class="docutils literal notranslate"><span class="pre">fetch_openml()</span></code> returns a Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> by default. To avoid this and keep the same code as in the book, we use <code class="docutils literal notranslate"><span class="pre">as_frame=False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import urllib.request
from sklearn.datasets import fetch_openml

mnist = fetch_openml(&#39;mnist_784&#39;, version=1, as_frame=False)
mnist.target = mnist.target.astype(np.int64)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split(
    mnist[&quot;data&quot;], mnist[&quot;target&quot;], random_state=42)
</pre></div>
</div>
</div>
</div>
<p>Next, let’s write it to a <code class="docutils literal notranslate"><span class="pre">memmap</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>filename = &quot;my_mnist.data&quot;
X_mm = np.memmap(filename, dtype=&#39;float32&#39;, mode=&#39;write&#39;, shape=X_train.shape)
X_mm[:] = X_train
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>minibatch_kmeans = MiniBatchKMeans(n_clusters=10, batch_size=10, random_state=42)
minibatch_kmeans.fit(X_mm)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MiniBatchKMeans(batch_size=10, n_clusters=10, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>If your data is so large that you cannot use <code class="docutils literal notranslate"><span class="pre">memmap</span></code>, things get more complicated. Let’s start by writing a function to load the next batch (in real life, you would load the data from disk):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def load_next_batch(batch_size):
    return X[np.random.choice(len(X), batch_size, replace=False)]
</pre></div>
</div>
</div>
</div>
<p>Now we can train the model by feeding it one batch at a time. We also need to implement multiple initializations and keep the model with the lowest inertia:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.random.seed(42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>k = 5
n_init = 10
n_iterations = 100
batch_size = 100
init_size = 500  # more data for K-Means++ initialization
evaluate_on_last_n_iters = 10

best_kmeans = None

for init in range(n_init):
    minibatch_kmeans = MiniBatchKMeans(n_clusters=k, init_size=init_size)
    X_init = load_next_batch(init_size)
    minibatch_kmeans.partial_fit(X_init)

    minibatch_kmeans.sum_inertia_ = 0
    for iteration in range(n_iterations):
        X_batch = load_next_batch(batch_size)
        minibatch_kmeans.partial_fit(X_batch)
        if iteration &gt;= n_iterations - evaluate_on_last_n_iters:
            minibatch_kmeans.sum_inertia_ += minibatch_kmeans.inertia_

    if (best_kmeans is None or
        minibatch_kmeans.sum_inertia_ &lt; best_kmeans.sum_inertia_):
        best_kmeans = minibatch_kmeans
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>best_kmeans.score(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-211.70999744411446
</pre></div>
</div>
</div>
</div>
<p>Mini-batch K-Means is much faster than regular K-Means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%timeit KMeans(n_clusters=5, random_state=42).fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>45.7 ms ± 245 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%timeit MiniBatchKMeans(n_clusters=5, random_state=42).fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.2 ms ± 107 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p>That’s <em>much</em> faster! However, its performance is often lower (higher inertia), and it keeps degrading as <em>k</em> increases. Let’s plot the inertia ratio and the training time ratio between Mini-batch K-Means and regular K-Means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from timeit import timeit
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>times = np.empty((100, 2))
inertias = np.empty((100, 2))
for k in range(1, 101):
    kmeans_ = KMeans(n_clusters=k, random_state=42)
    minibatch_kmeans = MiniBatchKMeans(n_clusters=k, random_state=42)
    print(&quot;\r{}/{}&quot;.format(k, 100), end=&quot;&quot;)
    times[k-1, 0] = timeit(&quot;kmeans_.fit(X)&quot;, number=10, globals=globals())
    times[k-1, 1]  = timeit(&quot;minibatch_kmeans.fit(X)&quot;, number=10, globals=globals())
    inertias[k-1, 0] = kmeans_.inertia_
    inertias[k-1, 1] = minibatch_kmeans.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100/100
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(10,4))

plt.subplot(121)
plt.plot(range(1, 101), inertias[:, 0], &quot;r--&quot;, label=&quot;K-Means&quot;)
plt.plot(range(1, 101), inertias[:, 1], &quot;b.-&quot;, label=&quot;Mini-batch K-Means&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=16)
plt.title(&quot;Inertia&quot;, fontsize=14)
plt.legend(fontsize=14)
plt.axis([1, 100, 0, 100])

plt.subplot(122)
plt.plot(range(1, 101), times[:, 0], &quot;r--&quot;, label=&quot;K-Means&quot;)
plt.plot(range(1, 101), times[:, 1], &quot;b.-&quot;, label=&quot;Mini-batch K-Means&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=16)
plt.title(&quot;Training time (seconds)&quot;, fontsize=14)
plt.axis([1, 100, 0, 6])

save_fig(&quot;minibatch_kmeans_vs_kmeans&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure minibatch_kmeans_vs_kmeans
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_113_1.png" src="../../_images/09_unsupervised_learning_113_1.png" />
</div>
</div>
</section>
<section id="finding-the-optimal-number-of-clusters">
<h3>Finding the optimal number of clusters<a class="headerlink" href="#finding-the-optimal-number-of-clusters" title="Permalink to this headline">#</a></h3>
<p>What if the number of clusters was set to a lower or greater value than 5?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_k3 = KMeans(n_clusters=3, random_state=42)
kmeans_k8 = KMeans(n_clusters=8, random_state=42)

plot_clusterer_comparison(kmeans_k3, kmeans_k8, X, &quot;$k=3$&quot;, &quot;$k=8$&quot;)
save_fig(&quot;bad_n_clusters_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure bad_n_clusters_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_116_1.png" src="../../_images/09_unsupervised_learning_116_1.png" />
</div>
</div>
<p>Ouch, these two models don’t look great. What about their inertias?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_k3.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>653.2223267580945
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_k8.inertia_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>118.44108623570081
</pre></div>
</div>
</div>
</div>
<p>No, we cannot simply take the value of <span class="math notranslate nohighlight">\(k\)</span> that minimizes the inertia, since it keeps getting lower as we increase <span class="math notranslate nohighlight">\(k\)</span>. Indeed, the more clusters there are, the closer each instance will be to its closest centroid, and therefore the lower the inertia will be. However, we can plot the inertia as a function of <span class="math notranslate nohighlight">\(k\)</span> and analyze the resulting curve:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_per_k = [KMeans(n_clusters=k, random_state=42).fit(X)
                for k in range(1, 10)]
inertias = [model.inertia_ for model in kmeans_per_k]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 3.5))
plt.plot(range(1, 10), inertias, &quot;bo-&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=14)
plt.ylabel(&quot;Inertia&quot;, fontsize=14)
plt.annotate(&#39;Elbow&#39;,
             xy=(4, inertias[3]),
             xytext=(0.55, 0.55),
             textcoords=&#39;figure fraction&#39;,
             fontsize=16,
             arrowprops=dict(facecolor=&#39;black&#39;, shrink=0.1)
            )
plt.axis([1, 8.5, 0, 1300])
save_fig(&quot;inertia_vs_k_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure inertia_vs_k_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_122_1.png" src="../../_images/09_unsupervised_learning_122_1.png" />
</div>
</div>
<p>As you can see, there is an elbow at <span class="math notranslate nohighlight">\(k=4\)</span>, which means that less clusters than that would be bad, and more clusters would not help much and might cut clusters in half. So <span class="math notranslate nohighlight">\(k=4\)</span> is a pretty good choice. Of course in this example it is not perfect since it means that the two blobs in the lower left will be considered as just a single cluster, but it’s a pretty good clustering nonetheless.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_decision_boundaries(kmeans_per_k[4-1], X)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_124_0.png" src="../../_images/09_unsupervised_learning_124_0.png" />
</div>
</div>
<p>Another approach is to look at the <em>silhouette score</em>, which is the mean <em>silhouette coefficient</em> over all the instances. An instance’s silhouette coefficient is equal to <span class="math notranslate nohighlight">\((b - a)/\max(a, b)\)</span> where <span class="math notranslate nohighlight">\(a\)</span> is the mean distance to the other instances in the same cluster (it is the <em>mean intra-cluster distance</em>), and <span class="math notranslate nohighlight">\(b\)</span> is the <em>mean nearest-cluster distance</em>, that is the mean distance to the instances of the next closest cluster (defined as the one that minimizes <span class="math notranslate nohighlight">\(b\)</span>, excluding the instance’s own cluster). The silhouette coefficient can vary between -1 and +1: a coefficient close to +1 means that the instance is well inside its own cluster and far from other clusters, while a coefficient close to 0 means that it is close to a cluster boundary, and finally a coefficient close to -1 means that the instance may have been assigned to the wrong cluster.</p>
<p>Let’s plot the silhouette score as a function of <span class="math notranslate nohighlight">\(k\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.metrics import silhouette_score
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>silhouette_score(X, kmeans.labels_)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.655517642572828
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>silhouette_scores = [silhouette_score(X, model.labels_)
                     for model in kmeans_per_k[1:]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 3))
plt.plot(range(2, 10), silhouette_scores, &quot;bo-&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=14)
plt.ylabel(&quot;Silhouette score&quot;, fontsize=14)
plt.axis([1.8, 8.5, 0.55, 0.7])
save_fig(&quot;silhouette_score_vs_k_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure silhouette_score_vs_k_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_130_1.png" src="../../_images/09_unsupervised_learning_130_1.png" />
</div>
</div>
<p>As you can see, this visualization is much richer than the previous one: in particular, although it confirms that <span class="math notranslate nohighlight">\(k=4\)</span> is a very good choice, but it also underlines the fact that <span class="math notranslate nohighlight">\(k=5\)</span> is quite good as well.</p>
<p>An even more informative visualization is given when you plot every instance’s silhouette coefficient, sorted by the cluster they are assigned to and by the value of the coefficient. This is called a <em>silhouette diagram</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.metrics import silhouette_samples
from matplotlib.ticker import FixedLocator, FixedFormatter

plt.figure(figsize=(11, 9))

for k in (3, 4, 5, 6):
    plt.subplot(2, 2, k - 2)
    
    y_pred = kmeans_per_k[k - 1].labels_
    silhouette_coefficients = silhouette_samples(X, y_pred)

    padding = len(X) // 30
    pos = padding
    ticks = []
    for i in range(k):
        coeffs = silhouette_coefficients[y_pred == i]
        coeffs.sort()

        color = mpl.cm.Spectral(i / k)
        plt.fill_betweenx(np.arange(pos, pos + len(coeffs)), 0, coeffs,
                          facecolor=color, edgecolor=color, alpha=0.7)
        ticks.append(pos + len(coeffs) // 2)
        pos += len(coeffs) + padding

    plt.gca().yaxis.set_major_locator(FixedLocator(ticks))
    plt.gca().yaxis.set_major_formatter(FixedFormatter(range(k)))
    if k in (3, 5):
        plt.ylabel(&quot;Cluster&quot;)
    
    if k in (5, 6):
        plt.gca().set_xticks([-0.1, 0, 0.2, 0.4, 0.6, 0.8, 1])
        plt.xlabel(&quot;Silhouette Coefficient&quot;)
    else:
        plt.tick_params(labelbottom=False)

    plt.axvline(x=silhouette_scores[k - 2], color=&quot;red&quot;, linestyle=&quot;--&quot;)
    plt.title(&quot;$k={}$&quot;.format(k), fontsize=16)

save_fig(&quot;silhouette_analysis_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure silhouette_analysis_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_133_1.png" src="../../_images/09_unsupervised_learning_133_1.png" />
</div>
</div>
<p>As you can see, <span class="math notranslate nohighlight">\(k=5\)</span> looks like the best option here, as all clusters are roughly the same size, and they all cross the dashed line, which represents the mean silhouette score.</p>
</section>
</section>
<section id="limits-of-k-means">
<h2>Limits of K-Means<a class="headerlink" href="#limits-of-k-means" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X1, y1 = make_blobs(n_samples=1000, centers=((4, -4), (0, 0)), random_state=42)
X1 = X1.dot(np.array([[0.374, 0.95], [0.732, 0.598]]))
X2, y2 = make_blobs(n_samples=250, centers=1, random_state=42)
X2 = X2 + [6, -8]
X = np.r_[X1, X2]
y = np.r_[y1, y2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_clusters(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_137_0.png" src="../../_images/09_unsupervised_learning_137_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans_good = KMeans(n_clusters=3, init=np.array([[-1.5, 2.5], [0.5, 0], [4, 0]]), n_init=1, random_state=42)
kmeans_bad = KMeans(n_clusters=3, random_state=42)
kmeans_good.fit(X)
kmeans_bad.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KMeans(n_clusters=3, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(10, 3.2))

plt.subplot(121)
plot_decision_boundaries(kmeans_good, X)
plt.title(&quot;Inertia = {:.1f}&quot;.format(kmeans_good.inertia_), fontsize=14)

plt.subplot(122)
plot_decision_boundaries(kmeans_bad, X, show_ylabels=False)
plt.title(&quot;Inertia = {:.1f}&quot;.format(kmeans_bad.inertia_), fontsize=14)

save_fig(&quot;bad_kmeans_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure bad_kmeans_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_139_1.png" src="../../_images/09_unsupervised_learning_139_1.png" />
</div>
</div>
</section>
<section id="using-clustering-for-image-segmentation">
<h2>Using Clustering for Image Segmentation<a class="headerlink" href="#using-clustering-for-image-segmentation" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Download the ladybug image
images_path = os.path.join(PROJECT_ROOT_DIR, &quot;images&quot;, &quot;unsupervised_learning&quot;)
os.makedirs(images_path, exist_ok=True)
DOWNLOAD_ROOT = &quot;https://raw.githubusercontent.com/ageron/handson-ml2/master/&quot;
filename = &quot;ladybug.png&quot;
print(&quot;Downloading&quot;, filename)
url = DOWNLOAD_ROOT + &quot;images/unsupervised_learning/&quot; + filename
urllib.request.urlretrieve(url, os.path.join(images_path, filename))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading ladybug.png
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;./images/unsupervised_learning/ladybug.png&#39;,
 &lt;http.client.HTTPMessage at 0x7fa4386b0090&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from matplotlib.image import imread
image = imread(os.path.join(images_path, filename))
image.shape
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(533, 800, 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X = image.reshape(-1, 3)
kmeans = KMeans(n_clusters=8, random_state=42).fit(X)
segmented_img = kmeans.cluster_centers_[kmeans.labels_]
segmented_img = segmented_img.reshape(image.shape)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>segmented_imgs = []
n_colors = (10, 8, 6, 4, 2)
for n_clusters in n_colors:
    kmeans = KMeans(n_clusters=n_clusters, random_state=42).fit(X)
    segmented_img = kmeans.cluster_centers_[kmeans.labels_]
    segmented_imgs.append(segmented_img.reshape(image.shape))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(10,5))
plt.subplots_adjust(wspace=0.05, hspace=0.1)

plt.subplot(231)
plt.imshow(image)
plt.title(&quot;Original image&quot;)
plt.axis(&#39;off&#39;)

for idx, n_clusters in enumerate(n_colors):
    plt.subplot(232 + idx)
    plt.imshow(segmented_imgs[idx])
    plt.title(&quot;{} colors&quot;.format(n_clusters))
    plt.axis(&#39;off&#39;)

save_fig(&#39;image_segmentation_diagram&#39;, tight_layout=False)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure image_segmentation_diagram
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_145_1.png" src="../../_images/09_unsupervised_learning_145_1.png" />
</div>
</div>
</section>
<section id="using-clustering-for-preprocessing">
<h2>Using Clustering for Preprocessing<a class="headerlink" href="#using-clustering-for-preprocessing" title="Permalink to this headline">#</a></h2>
<p>Let’s tackle the <em>digits dataset</em> which is a simple MNIST-like dataset containing 1,797 grayscale 8×8 images representing digits 0 to 9.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.datasets import load_digits
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_digits, y_digits = load_digits(return_X_y=True)
</pre></div>
</div>
</div>
</div>
<p>Let’s split it into a training set and a test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.model_selection import train_test_split
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train, X_test, y_train, y_test = train_test_split(X_digits, y_digits, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>Now let’s fit a Logistic Regression model and evaluate it on the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.linear_model import LogisticRegression
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg = LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, max_iter=5000, random_state=42)
log_reg.fit(X_train, y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression(max_iter=5000, multi_class=&#39;ovr&#39;, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg_score = log_reg.score(X_test, y_test)
log_reg_score
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9688888888888889
</pre></div>
</div>
</div>
</div>
<p>Okay, that’s our baseline: 96.89% accuracy. Let’s see if we can do better by using K-Means as a preprocessing step. We will create a pipeline that will first cluster the training set into 50 clusters and replace the images with their distances to the 50 clusters, then apply a logistic regression model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.pipeline import Pipeline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pipeline = Pipeline([
    (&quot;kmeans&quot;, KMeans(n_clusters=50, random_state=42)),
    (&quot;log_reg&quot;, LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, max_iter=5000, random_state=42)),
])
pipeline.fit(X_train, y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;kmeans&#39;, KMeans(n_clusters=50, random_state=42)),
                (&#39;log_reg&#39;,
                 LogisticRegression(max_iter=5000, multi_class=&#39;ovr&#39;,
                                    random_state=42))])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pipeline_score = pipeline.score(X_test, y_test)
pipeline_score
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.98
</pre></div>
</div>
</div>
</div>
<p>How much did the error rate drop?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>1 - (1 - pipeline_score) / (1 - log_reg_score)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3571428571428561
</pre></div>
</div>
</div>
</div>
<p>How about that? We reduced the error rate by over 35%! But we chose the number of clusters <span class="math notranslate nohighlight">\(k\)</span> completely arbitrarily, we can surely do better. Since K-Means is just a preprocessing step in a classification pipeline, finding a good value for <span class="math notranslate nohighlight">\(k\)</span> is much simpler than earlier: there’s no need to perform silhouette analysis or minimize the inertia, the best value of <span class="math notranslate nohighlight">\(k\)</span> is simply the one that results in the best classification performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.model_selection import GridSearchCV
</pre></div>
</div>
</div>
</div>
<p><strong>Warning</strong>: the following cell may take close to 20 minutes to run, or more depending on your hardware.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>param_grid = dict(kmeans__n_clusters=range(2, 100))
grid_clf = GridSearchCV(pipeline, param_grid, cv=3, verbose=2)
grid_clf.fit(X_train, y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 3 folds for each of 98 candidates, totalling 294 fits
[CV] kmeans__n_clusters=2 ............................................
[CV] ............................. kmeans__n_clusters=2, total=   0.2s
[CV] kmeans__n_clusters=2 ............................................
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.
[Parallel(n_jobs=1)]: Done   1 out of   1 | elapsed:    0.2s remaining:    0.0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[CV] ............................. kmeans__n_clusters=2, total=   0.1s
[CV] kmeans__n_clusters=2 ............................................
[CV] ............................. kmeans__n_clusters=2, total=   0.1s
[CV] kmeans__n_clusters=3 ............................................
[CV] ............................. kmeans__n_clusters=3, total=   0.2s
[CV] kmeans__n_clusters=3 ............................................
[CV] ............................. kmeans__n_clusters=3, total=   0.2s
[CV] kmeans__n_clusters=3 ............................................
[CV] ............................. kmeans__n_clusters=3, total=   0.2s
[CV] kmeans__n_clusters=4 ............................................
[CV] ............................. kmeans__n_clusters=4, total=   0.2s
[CV] kmeans__n_clusters=4 ............................................
[CV] ............................. kmeans__n_clusters=4, total=   0.2s
[CV] kmeans__n_clusters=4 ............................................
[CV] ............................. kmeans__n_clusters=4, total=   0.2s
[CV] kmeans__n_clusters=5 ............................................
[CV] ............................. kmeans__n_clusters=5, total=   0.2s
[CV] kmeans__n_clusters=5 ............................................
[CV] ............................. kmeans__n_clusters=5, total=   0.2s
[CV] kmeans__n_clusters=5 ............................................
[CV] ............................. kmeans__n_clusters=5, total=   0.2s
[CV] kmeans__n_clusters=6 ............................................
[CV] ............................. kmeans__n_clusters=6, total=   0.3s
[CV] kmeans__n_clusters=6 ............................................
[CV] ............................. kmeans__n_clusters=6, total=   0.3s
[CV] kmeans__n_clusters=6 ............................................
[CV] ............................. kmeans__n_clusters=6, total=   0.3s
[CV] kmeans__n_clusters=7 ............................................
[CV] ............................. kmeans__n_clusters=7, total=   0.3s
&lt;&lt;522 more lines&gt;&gt;
[CV] kmeans__n_clusters=94 ...........................................
[CV] ............................ kmeans__n_clusters=94, total=   4.2s
[CV] kmeans__n_clusters=94 ...........................................
[CV] ............................ kmeans__n_clusters=94, total=   3.6s
[CV] kmeans__n_clusters=95 ...........................................
[CV] ............................ kmeans__n_clusters=95, total=   3.8s
[CV] kmeans__n_clusters=95 ...........................................
[CV] ............................ kmeans__n_clusters=95, total=   4.4s
[CV] kmeans__n_clusters=95 ...........................................
[CV] ............................ kmeans__n_clusters=95, total=   3.7s
[CV] kmeans__n_clusters=96 ...........................................
[CV] ............................ kmeans__n_clusters=96, total=   4.7s
[CV] kmeans__n_clusters=96 ...........................................
[CV] ............................ kmeans__n_clusters=96, total=   4.1s
[CV] kmeans__n_clusters=96 ...........................................
[CV] ............................ kmeans__n_clusters=96, total=   4.0s
[CV] kmeans__n_clusters=97 ...........................................
[CV] ............................ kmeans__n_clusters=97, total=   4.2s
[CV] kmeans__n_clusters=97 ...........................................
[CV] ............................ kmeans__n_clusters=97, total=   4.5s
[CV] kmeans__n_clusters=97 ...........................................
[CV] ............................ kmeans__n_clusters=97, total=   3.9s
[CV] kmeans__n_clusters=98 ...........................................
[CV] ............................ kmeans__n_clusters=98, total=   4.3s
[CV] kmeans__n_clusters=98 ...........................................
[CV] ............................ kmeans__n_clusters=98, total=   4.2s
[CV] kmeans__n_clusters=98 ...........................................
[CV] ............................ kmeans__n_clusters=98, total=   4.0s
[CV] kmeans__n_clusters=99 ...........................................
[CV] ............................ kmeans__n_clusters=99, total=   4.4s
[CV] kmeans__n_clusters=99 ...........................................
[CV] ............................ kmeans__n_clusters=99, total=   4.3s
[CV] kmeans__n_clusters=99 ...........................................
[CV] ............................ kmeans__n_clusters=99, total=   4.5s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Parallel(n_jobs=1)]: Done 294 out of 294 | elapsed: 16.1min finished
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GridSearchCV(cv=3,
             estimator=Pipeline(steps=[(&#39;kmeans&#39;,
                                        KMeans(n_clusters=50, random_state=42)),
                                       (&#39;log_reg&#39;,
                                        LogisticRegression(max_iter=5000,
                                                           multi_class=&#39;ovr&#39;,
                                                           random_state=42))]),
             param_grid={&#39;kmeans__n_clusters&#39;: range(2, 100)}, verbose=2)
</pre></div>
</div>
</div>
</div>
<p>Let’s see what the best number of clusters is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>grid_clf.best_params_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;kmeans__n_clusters&#39;: 57}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>grid_clf.score(X_test, y_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.98
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-clustering-for-semi-supervised-learning">
<h2>Using Clustering for Semi-Supervised Learning<a class="headerlink" href="#using-clustering-for-semi-supervised-learning" title="Permalink to this headline">#</a></h2>
<p>Another use case for clustering is in semi-supervised learning, when we have plenty of unlabeled instances and very few labeled instances.</p>
<p>Let’s look at the performance of a logistic regression model when we only have 50 labeled instances:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_labeled = 50
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg = LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, random_state=42)
log_reg.fit(X_train[:n_labeled], y_train[:n_labeled])
log_reg.score(X_test, y_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8333333333333334
</pre></div>
</div>
</div>
</div>
<p>It’s much less than earlier of course. Let’s see how we can do better. First, let’s cluster the training set into 50 clusters, then for each cluster let’s find the image closest to the centroid. We will call these images the representative images:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>k = 50
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kmeans = KMeans(n_clusters=k, random_state=42)
X_digits_dist = kmeans.fit_transform(X_train)
representative_digit_idx = np.argmin(X_digits_dist, axis=0)
X_representative_digits = X_train[representative_digit_idx]
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot these representative images and label them manually:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 2))
for index, X_representative_digit in enumerate(X_representative_digits):
    plt.subplot(k // 10, 10, index + 1)
    plt.imshow(X_representative_digit.reshape(8, 8), cmap=&quot;binary&quot;, interpolation=&quot;bilinear&quot;)
    plt.axis(&#39;off&#39;)

save_fig(&quot;representative_images_diagram&quot;, tight_layout=False)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure representative_images_diagram
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_179_1.png" src="../../_images/09_unsupervised_learning_179_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_train[representative_digit_idx]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 3, 2, 7, 6, 4, 6, 9, 5, 1, 2, 9, 5, 2, 7, 8, 1, 8, 6, 3, 1,
       5, 4, 5, 4, 0, 3, 2, 6, 1, 7, 7, 9, 1, 8, 6, 5, 4, 8, 5, 3, 3, 6,
       7, 9, 7, 8, 4, 9])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_representative_digits = np.array([
    0, 1, 3, 2, 7, 6, 4, 6, 9, 5,
    1, 2, 9, 5, 2, 7, 8, 1, 8, 6,
    3, 2, 5, 4, 5, 4, 0, 3, 2, 6,
    1, 7, 7, 9, 1, 8, 6, 5, 4, 8,
    5, 3, 3, 6, 7, 9, 7, 8, 4, 9])
</pre></div>
</div>
</div>
</div>
<p>Now we have a dataset with just 50 labeled instances, but instead of being completely random instances, each of them is a representative image of its cluster. Let’s see if the performance is any better:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg = LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, max_iter=5000, random_state=42)
log_reg.fit(X_representative_digits, y_representative_digits)
log_reg.score(X_test, y_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9133333333333333
</pre></div>
</div>
</div>
</div>
<p>Wow! We jumped from 83.3% accuracy to 91.3%, although we are still only training the model on 50 instances. Since it’s often costly and painful to label instances, especially when it has to be done manually by experts, it’s a good idea to make them label representative instances rather than just random instances.</p>
<p>But perhaps we can go one step further: what if we propagated the labels to all the other instances in the same cluster?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_train_propagated = np.empty(len(X_train), dtype=np.int32)
for i in range(k):
    y_train_propagated[kmeans.labels_==i] = y_representative_digits[i]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg = LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, max_iter=5000, random_state=42)
log_reg.fit(X_train, y_train_propagated)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression(max_iter=5000, multi_class=&#39;ovr&#39;, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg.score(X_test, y_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9244444444444444
</pre></div>
</div>
</div>
</div>
<p>We got a tiny little accuracy boost. Better than nothing, but we should probably have propagated the labels only to the instances closest to the centroid, because by propagating to the full cluster, we have certainly included some outliers. Let’s only propagate the labels to the 75th percentile closest to the centroid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>percentile_closest = 75

X_cluster_dist = X_digits_dist[np.arange(len(X_train)), kmeans.labels_]
for i in range(k):
    in_cluster = (kmeans.labels_ == i)
    cluster_dist = X_cluster_dist[in_cluster]
    cutoff_distance = np.percentile(cluster_dist, percentile_closest)
    above_cutoff = (X_cluster_dist &gt; cutoff_distance)
    X_cluster_dist[in_cluster &amp; above_cutoff] = -1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>partially_propagated = (X_cluster_dist != -1)
X_train_partially_propagated = X_train[partially_propagated]
y_train_partially_propagated = y_train_propagated[partially_propagated]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg = LogisticRegression(multi_class=&quot;ovr&quot;, solver=&quot;lbfgs&quot;, max_iter=5000, random_state=42)
log_reg.fit(X_train_partially_propagated, y_train_partially_propagated)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression(max_iter=5000, multi_class=&#39;ovr&#39;, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log_reg.score(X_test, y_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9266666666666666
</pre></div>
</div>
</div>
</div>
<p>A bit better. With just 50 labeled instances (just 5 examples per class on average!), we got 92.7% performance, which is getting closer to the performance of logistic regression on the fully labeled <em>digits</em> dataset (which was 96.9%).</p>
<p>This is because the propagated labels are actually pretty good: their accuracy is close to 96%:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.mean(y_train_partially_propagated == y_train[partially_propagated])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9592039800995025
</pre></div>
</div>
</div>
</div>
<p>You could now do a few iterations of <em>active learning</em>:</p>
<ol class="simple">
<li><p>Manually label the instances that the classifier is least sure about, if possible by picking them in distinct clusters.</p></li>
<li><p>Train a new model with these additional labels.</p></li>
</ol>
</section>
<section id="dbscan">
<h2>DBSCAN<a class="headerlink" href="#dbscan" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.datasets import make_moons
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X, y = make_moons(n_samples=1000, noise=0.05, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import DBSCAN
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan = DBSCAN(eps=0.05, min_samples=5)
dbscan.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DBSCAN(eps=0.05)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan.labels_[:10]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  2, -1, -1,  1,  0,  0,  0,  2,  5])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>len(dbscan.core_sample_indices_)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>808
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan.core_sample_indices_[:10]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  4,  5,  6,  7,  8, 10, 11, 12, 13])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan.components_[:3]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.02137124,  0.40618608],
       [-0.84192557,  0.53058695],
       [ 0.58930337, -0.32137599]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.unique(dbscan.labels_)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-1,  0,  1,  2,  3,  4,  5,  6])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan2 = DBSCAN(eps=0.2)
dbscan2.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DBSCAN(eps=0.2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_dbscan(dbscan, X, size, show_xlabels=True, show_ylabels=True):
    core_mask = np.zeros_like(dbscan.labels_, dtype=bool)
    core_mask[dbscan.core_sample_indices_] = True
    anomalies_mask = dbscan.labels_ == -1
    non_core_mask = ~(core_mask | anomalies_mask)

    cores = dbscan.components_
    anomalies = X[anomalies_mask]
    non_cores = X[non_core_mask]
    
    plt.scatter(cores[:, 0], cores[:, 1],
                c=dbscan.labels_[core_mask], marker=&#39;o&#39;, s=size, cmap=&quot;Paired&quot;)
    plt.scatter(cores[:, 0], cores[:, 1], marker=&#39;*&#39;, s=20, c=dbscan.labels_[core_mask])
    plt.scatter(anomalies[:, 0], anomalies[:, 1],
                c=&quot;r&quot;, marker=&quot;x&quot;, s=100)
    plt.scatter(non_cores[:, 0], non_cores[:, 1], c=dbscan.labels_[non_core_mask], marker=&quot;.&quot;)
    if show_xlabels:
        plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
    else:
        plt.tick_params(labelbottom=False)
    if show_ylabels:
        plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
    else:
        plt.tick_params(labelleft=False)
    plt.title(&quot;eps={:.2f}, min_samples={}&quot;.format(dbscan.eps, dbscan.min_samples), fontsize=14)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(9, 3.2))

plt.subplot(121)
plot_dbscan(dbscan, X, size=100)

plt.subplot(122)
plot_dbscan(dbscan2, X, size=600, show_ylabels=False)

save_fig(&quot;dbscan_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure dbscan_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_210_1.png" src="../../_images/09_unsupervised_learning_210_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dbscan = dbscan2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.neighbors import KNeighborsClassifier
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>knn = KNeighborsClassifier(n_neighbors=50)
knn.fit(dbscan.components_, dbscan.labels_[dbscan.core_sample_indices_])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNeighborsClassifier(n_neighbors=50)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_new = np.array([[-0.5, 0], [0, 0.5], [1, -0.1], [2, 1]])
knn.predict(X_new)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1, 0, 1, 0])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>knn.predict_proba(X_new)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.18, 0.82],
       [1.  , 0.  ],
       [0.12, 0.88],
       [1.  , 0.  ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(6, 3))
plot_decision_boundaries(knn, X, show_centroids=False)
plt.scatter(X_new[:, 0], X_new[:, 1], c=&quot;b&quot;, marker=&quot;+&quot;, s=200, zorder=10)
save_fig(&quot;cluster_classification_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure cluster_classification_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_216_1.png" src="../../_images/09_unsupervised_learning_216_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_dist, y_pred_idx = knn.kneighbors(X_new, n_neighbors=1)
y_pred = dbscan.labels_[dbscan.core_sample_indices_][y_pred_idx]
y_pred[y_dist &gt; 0.2] = -1
y_pred.ravel()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-1,  0,  1, -1])
</pre></div>
</div>
</div>
</div>
</section>
<section id="other-clustering-algorithms">
<h2>Other Clustering Algorithms<a class="headerlink" href="#other-clustering-algorithms" title="Permalink to this headline">#</a></h2>
<section id="spectral-clustering">
<h3>Spectral Clustering<a class="headerlink" href="#spectral-clustering" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import SpectralClustering
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc1 = SpectralClustering(n_clusters=2, gamma=100, random_state=42)
sc1.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SpectralClustering(gamma=100, n_clusters=2, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc2 = SpectralClustering(n_clusters=2, gamma=1, random_state=42)
sc2.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SpectralClustering(gamma=1, n_clusters=2, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.percentile(sc1.affinity_matrix_, 95)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.04251990648936265
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_spectral_clustering(sc, X, size, alpha, show_xlabels=True, show_ylabels=True):
    plt.scatter(X[:, 0], X[:, 1], marker=&#39;o&#39;, s=size, c=&#39;gray&#39;, cmap=&quot;Paired&quot;, alpha=alpha)
    plt.scatter(X[:, 0], X[:, 1], marker=&#39;o&#39;, s=30, c=&#39;w&#39;)
    plt.scatter(X[:, 0], X[:, 1], marker=&#39;.&#39;, s=10, c=sc.labels_, cmap=&quot;Paired&quot;)
    
    if show_xlabels:
        plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
    else:
        plt.tick_params(labelbottom=False)
    if show_ylabels:
        plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
    else:
        plt.tick_params(labelleft=False)
    plt.title(&quot;RBF gamma={}&quot;.format(sc.gamma), fontsize=14)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(9, 3.2))

plt.subplot(121)
plot_spectral_clustering(sc1, X, size=500, alpha=0.1)

plt.subplot(122)
plot_spectral_clustering(sc2, X, size=4000, alpha=0.01, show_ylabels=False)

plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_225_0.png" src="../../_images/09_unsupervised_learning_225_0.png" />
</div>
</div>
</section>
<section id="agglomerative-clustering">
<h3>Agglomerative Clustering<a class="headerlink" href="#agglomerative-clustering" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import AgglomerativeClustering
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X = np.array([0, 2, 5, 8.5]).reshape(-1, 1)
agg = AgglomerativeClustering(linkage=&quot;complete&quot;).fit(X)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def learned_parameters(estimator):
    return [attrib for attrib in dir(estimator)
            if attrib.endswith(&quot;_&quot;) and not attrib.startswith(&quot;_&quot;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>learned_parameters(agg)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;children_&#39;,
 &#39;labels_&#39;,
 &#39;n_clusters_&#39;,
 &#39;n_connected_components_&#39;,
 &#39;n_features_in_&#39;,
 &#39;n_leaves_&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>agg.children_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0, 1],
       [2, 3],
       [4, 5]])
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="gaussian-mixtures">
<h1>Gaussian Mixtures<a class="headerlink" href="#gaussian-mixtures" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X1, y1 = make_blobs(n_samples=1000, centers=((4, -4), (0, 0)), random_state=42)
X1 = X1.dot(np.array([[0.374, 0.95], [0.732, 0.598]]))
X2, y2 = make_blobs(n_samples=250, centers=1, random_state=42)
X2 = X2 + [6, -8]
X = np.r_[X1, X2]
y = np.r_[y1, y2]
</pre></div>
</div>
</div>
</div>
<p>Let’s train a Gaussian mixture model on the previous dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.mixture import GaussianMixture
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm = GaussianMixture(n_components=3, n_init=10, random_state=42)
gm.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GaussianMixture(n_components=3, n_init=10, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the parameters that the EM algorithm estimated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.weights_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.39054348, 0.2093669 , 0.40008962])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.means_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.05224874,  0.07631976],
       [ 3.40196611,  1.05838748],
       [-1.40754214,  1.42716873]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.covariances_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[ 0.6890309 ,  0.79717058],
        [ 0.79717058,  1.21367348]],

       [[ 1.14296668, -0.03114176],
        [-0.03114176,  0.9545003 ]],

       [[ 0.63496849,  0.7298512 ],
        [ 0.7298512 ,  1.16112807]]])
</pre></div>
</div>
</div>
</div>
<p>Did the algorithm actually converge?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.converged_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Yes, good. How many iterations did it take?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.n_iter_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<p>You can now use the model to predict which cluster each instance belongs to (hard clustering) or the probabilities that it came from each cluster. For this, just use <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method or the <code class="docutils literal notranslate"><span class="pre">predict_proba()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.predict(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 0, 2, ..., 1, 1, 1])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.predict_proba(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[9.77227791e-01, 2.27715290e-02, 6.79898914e-07],
       [9.83288385e-01, 1.60345103e-02, 6.77104389e-04],
       [7.51824662e-05, 1.90251273e-06, 9.99922915e-01],
       ...,
       [4.35053542e-07, 9.99999565e-01, 2.17938894e-26],
       [5.27837047e-16, 1.00000000e+00, 1.50679490e-41],
       [2.32355608e-15, 1.00000000e+00, 8.21915701e-41]])
</pre></div>
</div>
</div>
</div>
<p>This is a generative model, so you can sample new instances from it (and get their labels):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_new, y_new = gm.sample(6)
X_new
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.8690223 , -0.32680051],
       [ 0.29945755,  0.2841852 ],
       [ 1.85027284,  2.06556913],
       [ 3.98260019,  1.50041446],
       [ 3.82006355,  0.53143606],
       [-1.04015332,  0.7864941 ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>y_new
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 0, 1, 1, 1, 2])
</pre></div>
</div>
</div>
</div>
<p>Notice that they are sampled sequentially from each cluster.</p>
<p>You can also estimate the log of the <em>probability density function</em> (PDF) at any location using the <code class="docutils literal notranslate"><span class="pre">score_samples()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.score_samples(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-2.60674489, -3.57074133, -3.33007348, ..., -3.51379355,
       -4.39643283, -3.8055665 ])
</pre></div>
</div>
</div>
</div>
<p>Let’s check that the PDF integrates to 1 over the whole space. We just take a large square around the clusters, and chop it into a grid of tiny squares, then we compute the approximate probability that the instances will be generated in each tiny square (by multiplying the PDF at one corner of the tiny square by the area of the square), and finally summing all these probabilities). The result is very close to 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>resolution = 100
grid = np.arange(-10, 10, 1 / resolution)
xx, yy = np.meshgrid(grid, grid)
X_full = np.vstack([xx.ravel(), yy.ravel()]).T

pdf = np.exp(gm.score_samples(X_full))
pdf_probas = pdf * (1 / resolution) ** 2
pdf_probas.sum()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9999999999271592
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot the resulting decision boundaries (dashed lines) and density contours:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from matplotlib.colors import LogNorm

def plot_gaussian_mixture(clusterer, X, resolution=1000, show_ylabels=True):
    mins = X.min(axis=0) - 0.1
    maxs = X.max(axis=0) + 0.1
    xx, yy = np.meshgrid(np.linspace(mins[0], maxs[0], resolution),
                         np.linspace(mins[1], maxs[1], resolution))
    Z = -clusterer.score_samples(np.c_[xx.ravel(), yy.ravel()])
    Z = Z.reshape(xx.shape)

    plt.contourf(xx, yy, Z,
                 norm=LogNorm(vmin=1.0, vmax=30.0),
                 levels=np.logspace(0, 2, 12))
    plt.contour(xx, yy, Z,
                norm=LogNorm(vmin=1.0, vmax=30.0),
                levels=np.logspace(0, 2, 12),
                linewidths=1, colors=&#39;k&#39;)

    Z = clusterer.predict(np.c_[xx.ravel(), yy.ravel()])
    Z = Z.reshape(xx.shape)
    plt.contour(xx, yy, Z,
                linewidths=2, colors=&#39;r&#39;, linestyles=&#39;dashed&#39;)
    
    plt.plot(X[:, 0], X[:, 1], &#39;k.&#39;, markersize=2)
    plot_centroids(clusterer.means_, clusterer.weights_)

    plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
    if show_ylabels:
        plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)
    else:
        plt.tick_params(labelleft=False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 4))

plot_gaussian_mixture(gm, X)

save_fig(&quot;gaussian_mixtures_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure gaussian_mixtures_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_258_1.png" src="../../_images/09_unsupervised_learning_258_1.png" />
</div>
</div>
<p>You can impose constraints on the covariance matrices that the algorithm looks for by setting the <code class="docutils literal notranslate"><span class="pre">covariance_type</span></code> hyperparameter:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;full&quot;</span></code> (default): no constraint, all clusters can take on any ellipsoidal shape of any size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;tied&quot;</span></code>: all clusters must have the same shape, which can be any ellipsoid (i.e., they all share the same covariance matrix).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;spherical&quot;</span></code>: all clusters must be spherical, but they can have different diameters (i.e., different variances).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;diag&quot;</span></code>: clusters can take on any ellipsoidal shape of any size, but the ellipsoid’s axes must be parallel to the axes (i.e., the covariance matrices must be diagonal).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm_full = GaussianMixture(n_components=3, n_init=10, covariance_type=&quot;full&quot;, random_state=42)
gm_tied = GaussianMixture(n_components=3, n_init=10, covariance_type=&quot;tied&quot;, random_state=42)
gm_spherical = GaussianMixture(n_components=3, n_init=10, covariance_type=&quot;spherical&quot;, random_state=42)
gm_diag = GaussianMixture(n_components=3, n_init=10, covariance_type=&quot;diag&quot;, random_state=42)
gm_full.fit(X)
gm_tied.fit(X)
gm_spherical.fit(X)
gm_diag.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GaussianMixture(covariance_type=&#39;diag&#39;, n_components=3, n_init=10,
                random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def compare_gaussian_mixtures(gm1, gm2, X):
    plt.figure(figsize=(9, 4))

    plt.subplot(121)
    plot_gaussian_mixture(gm1, X)
    plt.title(&#39;covariance_type=&quot;{}&quot;&#39;.format(gm1.covariance_type), fontsize=14)

    plt.subplot(122)
    plot_gaussian_mixture(gm2, X, show_ylabels=False)
    plt.title(&#39;covariance_type=&quot;{}&quot;&#39;.format(gm2.covariance_type), fontsize=14)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>compare_gaussian_mixtures(gm_tied, gm_spherical, X)

save_fig(&quot;covariance_type_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure covariance_type_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_262_1.png" src="../../_images/09_unsupervised_learning_262_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>compare_gaussian_mixtures(gm_full, gm_diag, X)
plt.tight_layout()
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_263_0.png" src="../../_images/09_unsupervised_learning_263_0.png" />
</div>
</div>
<section id="anomaly-detection-using-gaussian-mixtures">
<h2>Anomaly Detection Using Gaussian Mixtures<a class="headerlink" href="#anomaly-detection-using-gaussian-mixtures" title="Permalink to this headline">#</a></h2>
<p>Gaussian Mixtures can be used for <em>anomaly detection</em>: instances located in low-density regions can be considered anomalies. You must define what density threshold you want to use. For example, in a manufacturing company that tries to detect defective products, the ratio of defective products is usually well-known. Say it is equal to 4%, then you can set the density threshold to be the value that results in having 4% of the instances located in areas below that threshold density:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>densities = gm.score_samples(X)
density_threshold = np.percentile(densities, 4)
anomalies = X[densities &lt; density_threshold]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 4))

plot_gaussian_mixture(gm, X)
plt.scatter(anomalies[:, 0], anomalies[:, 1], color=&#39;r&#39;, marker=&#39;*&#39;)
plt.ylim(top=5.1)

save_fig(&quot;mixture_anomaly_detection_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure mixture_anomaly_detection_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_267_1.png" src="../../_images/09_unsupervised_learning_267_1.png" />
</div>
</div>
</section>
<section id="selecting-the-number-of-clusters">
<h2>Selecting the Number of Clusters<a class="headerlink" href="#selecting-the-number-of-clusters" title="Permalink to this headline">#</a></h2>
<p>We cannot use the inertia or the silhouette score because they both assume that the clusters are spherical. Instead, we can try to find the model that minimizes a theoretical information criterion such as the Bayesian Information Criterion (BIC) or the Akaike Information Criterion (AIC):</p>
<p><span class="math notranslate nohighlight">\({BIC} = {\log(m)p - 2\log({\hat L})}\)</span></p>
<p><span class="math notranslate nohighlight">\({AIC} = 2p - 2\log(\hat L)\)</span></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(m\)</span> is the number of instances.</p></li>
<li><p><span class="math notranslate nohighlight">\(p\)</span> is the number of parameters learned by the model.</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat L\)</span> is the maximized value of the likelihood function of the model. This is the conditional probability of the observed data <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>, given the model and its optimized parameters.</p></li>
</ul>
<p>Both BIC and AIC penalize models that have more parameters to learn (e.g., more clusters), and reward models that fit the data well (i.e., models that give a high likelihood to the observed data).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.bic(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8189.662685850681
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.aic(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8102.437405735643
</pre></div>
</div>
</div>
</div>
<p>We could compute the BIC manually like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_clusters = 3
n_dims = 2
n_params_for_weights = n_clusters - 1
n_params_for_means = n_clusters * n_dims
n_params_for_covariance = n_clusters * n_dims * (n_dims + 1) // 2
n_params = n_params_for_weights + n_params_for_means + n_params_for_covariance
max_log_likelihood = gm.score(X) * len(X) # log(L^)
bic = np.log(len(X)) * n_params - 2 * max_log_likelihood
aic = 2 * n_params - 2 * max_log_likelihood
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bic, aic
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(8189.662685850681, 8102.437405735643)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_params
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17
</pre></div>
</div>
</div>
</div>
<p>There’s one weight per cluster, but the sum must be equal to 1, so we have one degree of freedom less, hence the -1. Similarly, the degrees of freedom for an <span class="math notranslate nohighlight">\(n \times n\)</span> covariance matrix is not <span class="math notranslate nohighlight">\(n^2\)</span>, but <span class="math notranslate nohighlight">\(1 + 2 + \dots + n = \dfrac{n (n+1)}{2}\)</span>.</p>
<p>Let’s train Gaussian Mixture models with various values of <span class="math notranslate nohighlight">\(k\)</span> and measure their BIC:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gms_per_k = [GaussianMixture(n_components=k, n_init=10, random_state=42).fit(X)
             for k in range(1, 11)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bics = [model.bic(X) for model in gms_per_k]
aics = [model.aic(X) for model in gms_per_k]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 3))
plt.plot(range(1, 11), bics, &quot;bo-&quot;, label=&quot;BIC&quot;)
plt.plot(range(1, 11), aics, &quot;go--&quot;, label=&quot;AIC&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=14)
plt.ylabel(&quot;Information Criterion&quot;, fontsize=14)
plt.axis([1, 9.5, np.min(aics) - 50, np.max(aics) + 50])
plt.annotate(&#39;Minimum&#39;,
             xy=(3, bics[2]),
             xytext=(0.35, 0.6),
             textcoords=&#39;figure fraction&#39;,
             fontsize=14,
             arrowprops=dict(facecolor=&#39;black&#39;, shrink=0.1)
            )
plt.legend()
save_fig(&quot;aic_bic_vs_k_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure aic_bic_vs_k_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_280_1.png" src="../../_images/09_unsupervised_learning_280_1.png" />
</div>
</div>
<p>Let’s search for best combination of values for both the number of clusters and the <code class="docutils literal notranslate"><span class="pre">covariance_type</span></code> hyperparameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>min_bic = np.infty

for k in range(1, 11):
    for covariance_type in (&quot;full&quot;, &quot;tied&quot;, &quot;spherical&quot;, &quot;diag&quot;):
        bic = GaussianMixture(n_components=k, n_init=10,
                              covariance_type=covariance_type,
                              random_state=42).fit(X).bic(X)
        if bic &lt; min_bic:
            min_bic = bic
            best_k = k
            best_covariance_type = covariance_type
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>best_k
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>best_covariance_type
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;full&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="bayesian-gaussian-mixture-models">
<h2>Bayesian Gaussian Mixture Models<a class="headerlink" href="#bayesian-gaussian-mixture-models" title="Permalink to this headline">#</a></h2>
<p>Rather than manually searching for the optimal number of clusters, it is possible to use instead the <code class="docutils literal notranslate"><span class="pre">BayesianGaussianMixture</span></code> class which is capable of giving weights equal (or close) to zero to unnecessary clusters. Just set the number of components to a value that you believe is greater than the optimal number of clusters, and the algorithm will eliminate the unnecessary clusters automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.mixture import BayesianGaussianMixture
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bgm = BayesianGaussianMixture(n_components=10, n_init=10, random_state=42)
bgm.fit(X)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ageron/miniconda3/envs/tf2/lib/python3.7/site-packages/sklearn/mixture/_base.py:269: ConvergenceWarning: Initialization 10 did not converge. Try different init parameters, or increase max_iter, tol or check for degenerate data.
  % (init + 1), ConvergenceWarning)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BayesianGaussianMixture(n_components=10, n_init=10, random_state=42)
</pre></div>
</div>
</div>
</div>
<p>The algorithm automatically detected that only 3 components are needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.round(bgm.weights_, 2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.4 , 0.  , 0.  , 0.  , 0.39, 0.2 , 0.  , 0.  , 0.  , 0.  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(8, 5))
plot_gaussian_mixture(bgm, X)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_291_0.png" src="../../_images/09_unsupervised_learning_291_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bgm_low = BayesianGaussianMixture(n_components=10, max_iter=1000, n_init=1,
                                  weight_concentration_prior=0.01, random_state=42)
bgm_high = BayesianGaussianMixture(n_components=10, max_iter=1000, n_init=1,
                                  weight_concentration_prior=10000, random_state=42)
nn = 73
bgm_low.fit(X[:nn])
bgm_high.fit(X[:nn])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BayesianGaussianMixture(max_iter=1000, n_components=10, random_state=42,
                        weight_concentration_prior=10000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.round(bgm_low.weights_, 2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.49, 0.51, 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.round(bgm_high.weights_, 2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.43, 0.01, 0.01, 0.11, 0.01, 0.01, 0.01, 0.37, 0.01, 0.01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(9, 4))

plt.subplot(121)
plot_gaussian_mixture(bgm_low, X[:nn])
plt.title(&quot;weight_concentration_prior = 0.01&quot;, fontsize=14)

plt.subplot(122)
plot_gaussian_mixture(bgm_high, X[:nn], show_ylabels=False)
plt.title(&quot;weight_concentration_prior = 10000&quot;, fontsize=14)

save_fig(&quot;mixture_concentration_prior_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure mixture_concentration_prior_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_295_1.png" src="../../_images/09_unsupervised_learning_295_1.png" />
</div>
</div>
<p>Note: the fact that you see only 3 regions in the right plot although there are 4 centroids is not a bug. The weight of the top-right cluster is much larger than the weight of the lower-right cluster, so the probability that any given point in this region belongs to the top right cluster is greater than the probability that it belongs to the lower-right cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_moons, y_moons = make_moons(n_samples=1000, noise=0.05, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bgm = BayesianGaussianMixture(n_components=10, n_init=10, random_state=42)
bgm.fit(X_moons)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BayesianGaussianMixture(n_components=10, n_init=10, random_state=42)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(9, 3.2))

plt.subplot(121)
plot_data(X_moons)
plt.xlabel(&quot;$x_1$&quot;, fontsize=14)
plt.ylabel(&quot;$x_2$&quot;, fontsize=14, rotation=0)

plt.subplot(122)
plot_gaussian_mixture(bgm, X_moons, show_ylabels=False)

save_fig(&quot;moons_vs_bgm_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure moons_vs_bgm_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_299_1.png" src="../../_images/09_unsupervised_learning_299_1.png" />
</div>
</div>
<p>Oops, not great… instead of detecting 2 moon-shaped clusters, the algorithm detected 8 ellipsoidal clusters. However, the density plot does not look too bad, so it might be usable for anomaly detection.</p>
<p><strong>Likelihood Function</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from scipy.stats import norm
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>xx = np.linspace(-6, 4, 101)
ss = np.linspace(1, 2, 101)
XX, SS = np.meshgrid(xx, ss)
ZZ = 2 * norm.pdf(XX - 1.0, 0, SS) + norm.pdf(XX + 4.0, 0, SS)
ZZ = ZZ / ZZ.sum(axis=1)[:,np.newaxis] / (xx[1] - xx[0])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from matplotlib.patches import Polygon

plt.figure(figsize=(8, 4.5))

x_idx = 85
s_idx = 30

plt.subplot(221)
plt.contourf(XX, SS, ZZ, cmap=&quot;GnBu&quot;)
plt.plot([-6, 4], [ss[s_idx], ss[s_idx]], &quot;k-&quot;, linewidth=2)
plt.plot([xx[x_idx], xx[x_idx]], [1, 2], &quot;b-&quot;, linewidth=2)
plt.xlabel(r&quot;$x$&quot;)
plt.ylabel(r&quot;$\theta$&quot;, fontsize=14, rotation=0)
plt.title(r&quot;Model $f(x; \theta)$&quot;, fontsize=14)

plt.subplot(222)
plt.plot(ss, ZZ[:, x_idx], &quot;b-&quot;)
max_idx = np.argmax(ZZ[:, x_idx])
max_val = np.max(ZZ[:, x_idx])
plt.plot(ss[max_idx], max_val, &quot;r.&quot;)
plt.plot([ss[max_idx], ss[max_idx]], [0, max_val], &quot;r:&quot;)
plt.plot([0, ss[max_idx]], [max_val, max_val], &quot;r:&quot;)
plt.text(1.01, max_val + 0.005, r&quot;$\hat{L}$&quot;, fontsize=14)
plt.text(ss[max_idx]+ 0.01, 0.055, r&quot;$\hat{\theta}$&quot;, fontsize=14)
plt.text(ss[max_idx]+ 0.01, max_val - 0.012, r&quot;$Max$&quot;, fontsize=12)
plt.axis([1, 2, 0.05, 0.15])
plt.xlabel(r&quot;$\theta$&quot;, fontsize=14)
plt.grid(True)
plt.text(1.99, 0.135, r&quot;$=f(x=2.5; \theta)$&quot;, fontsize=14, ha=&quot;right&quot;)
plt.title(r&quot;Likelihood function $\mathcal{L}(\theta|x=2.5)$&quot;, fontsize=14)

plt.subplot(223)
plt.plot(xx, ZZ[s_idx], &quot;k-&quot;)
plt.axis([-6, 4, 0, 0.25])
plt.xlabel(r&quot;$x$&quot;, fontsize=14)
plt.grid(True)
plt.title(r&quot;PDF $f(x; \theta=1.3)$&quot;, fontsize=14)
verts = [(xx[41], 0)] + list(zip(xx[41:81], ZZ[s_idx, 41:81])) + [(xx[80], 0)]
poly = Polygon(verts, facecolor=&#39;0.9&#39;, edgecolor=&#39;0.5&#39;)
plt.gca().add_patch(poly)

plt.subplot(224)
plt.plot(ss, np.log(ZZ[:, x_idx]), &quot;b-&quot;)
max_idx = np.argmax(np.log(ZZ[:, x_idx]))
max_val = np.max(np.log(ZZ[:, x_idx]))
plt.plot(ss[max_idx], max_val, &quot;r.&quot;)
plt.plot([ss[max_idx], ss[max_idx]], [-5, max_val], &quot;r:&quot;)
plt.plot([0, ss[max_idx]], [max_val, max_val], &quot;r:&quot;)
plt.axis([1, 2, -2.4, -2])
plt.xlabel(r&quot;$\theta$&quot;, fontsize=14)
plt.text(ss[max_idx]+ 0.01, max_val - 0.05, r&quot;$Max$&quot;, fontsize=12)
plt.text(ss[max_idx]+ 0.01, -2.39, r&quot;$\hat{\theta}$&quot;, fontsize=14)
plt.text(1.01, max_val + 0.02, r&quot;$\log \, \hat{L}$&quot;, fontsize=14)
plt.grid(True)
plt.title(r&quot;$\log \, \mathcal{L}(\theta|x=2.5)$&quot;, fontsize=14)

save_fig(&quot;likelihood_function_plot&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure likelihood_function_plot
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_304_1.png" src="../../_images/09_unsupervised_learning_304_1.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exercise-solutions">
<h1>Exercise solutions<a class="headerlink" href="#exercise-solutions" title="Permalink to this headline">#</a></h1>
<section id="to-9">
<h2>1. to 9.<a class="headerlink" href="#to-9" title="Permalink to this headline">#</a></h2>
<p>See Appendix A.</p>
</section>
<section id="cluster-the-olivetti-faces-dataset">
<h2>10. Cluster the Olivetti Faces Dataset<a class="headerlink" href="#cluster-the-olivetti-faces-dataset" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: The classic Olivetti faces dataset contains 400 grayscale 64 × 64–pixel images of faces. Each image is flattened to a 1D vector of size 4,096. 40 different people were photographed (10 times each), and the usual task is to train a model that can predict which person is represented in each picture. Load the dataset using the <code class="docutils literal notranslate"><span class="pre">sklearn.datasets.fetch_olivetti_faces()</span></code> function.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.datasets import fetch_olivetti_faces

olivetti = fetch_olivetti_faces()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(olivetti.DESCR)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.. _olivetti_faces_dataset:

The Olivetti faces dataset
--------------------------

`This dataset contains a set of face images`_ taken between April 1992 and 
April 1994 at AT&amp;T Laboratories Cambridge. The
:func:`sklearn.datasets.fetch_olivetti_faces` function is the data
fetching / caching function that downloads the data
archive from AT&amp;T.

.. _This dataset contains a set of face images: http://www.cl.cam.ac.uk/research/dtg/attarchive/facedatabase.html

As described on the original website:

    There are ten different images of each of 40 distinct subjects. For some
    subjects, the images were taken at different times, varying the lighting,
    facial expressions (open / closed eyes, smiling / not smiling) and facial
    details (glasses / no glasses). All the images were taken against a dark
    homogeneous background with the subjects in an upright, frontal position 
    (with tolerance for some side movement).

**Data Set Characteristics:**

    =================   =====================
    Classes                                40
    Samples total                         400
    Dimensionality                       4096
    Features            real, between 0 and 1
    =================   =====================

The image is quantized to 256 grey levels and stored as unsigned 8-bit 
integers; the loader will convert these to floating point values on the 
interval [0, 1], which are easier to work with for many algorithms.

The &quot;target&quot; for this database is an integer from 0 to 39 indicating the
identity of the person pictured; however, with only 10 examples per class, this
relatively small dataset is more interesting from an unsupervised or
semi-supervised perspective.

The original dataset consisted of 92 x 112, while the version available here
consists of 64x64 images.

When using these images, please give credit to AT&amp;T Laboratories Cambridge.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>olivetti.target
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  1,
        1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  3,  3,  3,  3,
        3,  3,  3,  3,  3,  3,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  5,
        5,  5,  5,  5,  5,  5,  5,  5,  5,  6,  6,  6,  6,  6,  6,  6,  6,
        6,  6,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  8,  8,  8,  8,  8,
        8,  8,  8,  8,  8,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9, 10, 10,
       10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11,
       11, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13,
       13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15,
       15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
       17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18,
       18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20,
       20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22,
       22, 22, 22, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23,
       23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 25, 25, 25, 25, 25,
       25, 25, 25, 25, 25, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 27, 27,
       27, 27, 27, 27, 27, 27, 27, 27, 28, 28, 28, 28, 28, 28, 28, 28, 28,
       28, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 30, 30, 30, 30, 30, 30,
       30, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 32,
       32, 32, 32, 32, 32, 32, 32, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33,
       34, 34, 34, 34, 34, 34, 34, 34, 34, 34, 35, 35, 35, 35, 35, 35, 35,
       35, 35, 35, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 37, 37, 37, 37,
       37, 37, 37, 37, 37, 37, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 39,
       39, 39, 39, 39, 39, 39, 39, 39, 39])
</pre></div>
</div>
</div>
</div>
<p><em>Exercise: Then split it into a training set, a validation set, and a test set (note that the dataset is already scaled between 0 and 1). Since the dataset is quite small, you probably want to use stratified sampling to ensure that there are the same number of images per person in each set.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.model_selection import StratifiedShuffleSplit

strat_split = StratifiedShuffleSplit(n_splits=1, test_size=40, random_state=42)
train_valid_idx, test_idx = next(strat_split.split(olivetti.data, olivetti.target))
X_train_valid = olivetti.data[train_valid_idx]
y_train_valid = olivetti.target[train_valid_idx]
X_test = olivetti.data[test_idx]
y_test = olivetti.target[test_idx]

strat_split = StratifiedShuffleSplit(n_splits=1, test_size=80, random_state=43)
train_idx, valid_idx = next(strat_split.split(X_train_valid, y_train_valid))
X_train = X_train_valid[train_idx]
y_train = y_train_valid[train_idx]
X_valid = X_train_valid[valid_idx]
y_valid = y_train_valid[valid_idx]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(X_train.shape, y_train.shape)
print(X_valid.shape, y_valid.shape)
print(X_test.shape, y_test.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(280, 4096) (280,)
(80, 4096) (80,)
(40, 4096) (40,)
</pre></div>
</div>
</div>
</div>
<p>To speed things up, we’ll reduce the data’s dimensionality using PCA:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.decomposition import PCA

pca = PCA(0.99)
X_train_pca = pca.fit_transform(X_train)
X_valid_pca = pca.transform(X_valid)
X_test_pca = pca.transform(X_test)

pca.n_components_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>199
</pre></div>
</div>
</div>
</div>
<p><em>Exercise: Next, cluster the images using K-Means, and ensure that you have a good number of clusters (using one of the techniques discussed in this chapter).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.cluster import KMeans

k_range = range(5, 150, 5)
kmeans_per_k = []
for k in k_range:
    print(&quot;k={}&quot;.format(k))
    kmeans = KMeans(n_clusters=k, random_state=42).fit(X_train_pca)
    kmeans_per_k.append(kmeans)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>k=5
k=10
k=15
k=20
k=25
k=30
k=35
k=40
k=45
k=50
k=55
k=60
k=65
k=70
k=75
k=80
k=85
k=90
k=95
k=100
k=105
k=110
k=115
k=120
k=125
k=130
k=135
k=140
k=145
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.metrics import silhouette_score

silhouette_scores = [silhouette_score(X_train_pca, model.labels_)
                     for model in kmeans_per_k]
best_index = np.argmax(silhouette_scores)
best_k = k_range[best_index]
best_score = silhouette_scores[best_index]

plt.figure(figsize=(8, 3))
plt.plot(k_range, silhouette_scores, &quot;bo-&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=14)
plt.ylabel(&quot;Silhouette score&quot;, fontsize=14)
plt.plot(best_k, best_score, &quot;rs&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_320_0.png" src="../../_images/09_unsupervised_learning_320_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>best_k
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>120
</pre></div>
</div>
</div>
</div>
<p>It looks like the best number of clusters is quite high, at 120. You might have expected it to be 40, since there are 40 different people on the pictures. However, the same person may look quite different on different pictures (e.g., with or without glasses, or simply shifted left or right).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>inertias = [model.inertia_ for model in kmeans_per_k]
best_inertia = inertias[best_index]

plt.figure(figsize=(8, 3.5))
plt.plot(k_range, inertias, &quot;bo-&quot;)
plt.xlabel(&quot;$k$&quot;, fontsize=14)
plt.ylabel(&quot;Inertia&quot;, fontsize=14)
plt.plot(best_k, best_inertia, &quot;rs&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_323_0.png" src="../../_images/09_unsupervised_learning_323_0.png" />
</div>
</div>
<p>The optimal number of clusters is not clear on this inertia diagram, as there is no obvious elbow, so let’s stick with k=120.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>best_model = kmeans_per_k[best_index]
</pre></div>
</div>
</div>
</div>
<p><em>Exercise: Visualize the clusters: do you see similar faces in each cluster?</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_faces(faces, labels, n_cols=5):
    faces = faces.reshape(-1, 64, 64)
    n_rows = (len(faces) - 1) // n_cols + 1
    plt.figure(figsize=(n_cols, n_rows * 1.1))
    for index, (face, label) in enumerate(zip(faces, labels)):
        plt.subplot(n_rows, n_cols, index + 1)
        plt.imshow(face, cmap=&quot;gray&quot;)
        plt.axis(&quot;off&quot;)
        plt.title(label)
    plt.show()

for cluster_id in np.unique(best_model.labels_):
    print(&quot;Cluster&quot;, cluster_id)
    in_cluster = best_model.labels_==cluster_id
    faces = X_train[in_cluster]
    labels = y_train[in_cluster]
    plot_faces(faces, labels)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 0
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_1.png" src="../../_images/09_unsupervised_learning_327_1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 1
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_3.png" src="../../_images/09_unsupervised_learning_327_3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 2
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_5.png" src="../../_images/09_unsupervised_learning_327_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 3
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_7.png" src="../../_images/09_unsupervised_learning_327_7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 4
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_9.png" src="../../_images/09_unsupervised_learning_327_9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 5
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_11.png" src="../../_images/09_unsupervised_learning_327_11.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 6
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_13.png" src="../../_images/09_unsupervised_learning_327_13.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 7
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_15.png" src="../../_images/09_unsupervised_learning_327_15.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 8
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_17.png" src="../../_images/09_unsupervised_learning_327_17.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 9
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_19.png" src="../../_images/09_unsupervised_learning_327_19.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 10
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_21.png" src="../../_images/09_unsupervised_learning_327_21.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 11
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_23.png" src="../../_images/09_unsupervised_learning_327_23.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 12
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_25.png" src="../../_images/09_unsupervised_learning_327_25.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 13
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_27.png" src="../../_images/09_unsupervised_learning_327_27.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 14
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_29.png" src="../../_images/09_unsupervised_learning_327_29.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 15
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_31.png" src="../../_images/09_unsupervised_learning_327_31.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 16
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_33.png" src="../../_images/09_unsupervised_learning_327_33.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 17
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_35.png" src="../../_images/09_unsupervised_learning_327_35.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 18
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_37.png" src="../../_images/09_unsupervised_learning_327_37.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 19
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_39.png" src="../../_images/09_unsupervised_learning_327_39.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 20
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_41.png" src="../../_images/09_unsupervised_learning_327_41.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 21
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_43.png" src="../../_images/09_unsupervised_learning_327_43.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 22
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_45.png" src="../../_images/09_unsupervised_learning_327_45.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 23
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_47.png" src="../../_images/09_unsupervised_learning_327_47.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 24
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_49.png" src="../../_images/09_unsupervised_learning_327_49.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 25
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_51.png" src="../../_images/09_unsupervised_learning_327_51.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 26
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_53.png" src="../../_images/09_unsupervised_learning_327_53.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 27
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_55.png" src="../../_images/09_unsupervised_learning_327_55.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 28
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_57.png" src="../../_images/09_unsupervised_learning_327_57.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 29
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_59.png" src="../../_images/09_unsupervised_learning_327_59.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 30
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_61.png" src="../../_images/09_unsupervised_learning_327_61.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 31
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_63.png" src="../../_images/09_unsupervised_learning_327_63.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 32
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_65.png" src="../../_images/09_unsupervised_learning_327_65.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 33
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_67.png" src="../../_images/09_unsupervised_learning_327_67.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 34
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_69.png" src="../../_images/09_unsupervised_learning_327_69.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 35
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_71.png" src="../../_images/09_unsupervised_learning_327_71.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 36
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_73.png" src="../../_images/09_unsupervised_learning_327_73.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 37
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_75.png" src="../../_images/09_unsupervised_learning_327_75.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 38
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_77.png" src="../../_images/09_unsupervised_learning_327_77.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 39
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_79.png" src="../../_images/09_unsupervised_learning_327_79.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 40
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_81.png" src="../../_images/09_unsupervised_learning_327_81.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 41
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_83.png" src="../../_images/09_unsupervised_learning_327_83.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 42
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_85.png" src="../../_images/09_unsupervised_learning_327_85.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 43
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_87.png" src="../../_images/09_unsupervised_learning_327_87.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 44
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_89.png" src="../../_images/09_unsupervised_learning_327_89.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 45
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_91.png" src="../../_images/09_unsupervised_learning_327_91.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 46
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_93.png" src="../../_images/09_unsupervised_learning_327_93.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 47
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_95.png" src="../../_images/09_unsupervised_learning_327_95.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 48
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_97.png" src="../../_images/09_unsupervised_learning_327_97.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 49
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_99.png" src="../../_images/09_unsupervised_learning_327_99.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 50
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_101.png" src="../../_images/09_unsupervised_learning_327_101.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 51
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_103.png" src="../../_images/09_unsupervised_learning_327_103.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 52
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_105.png" src="../../_images/09_unsupervised_learning_327_105.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 53
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_107.png" src="../../_images/09_unsupervised_learning_327_107.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 54
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_109.png" src="../../_images/09_unsupervised_learning_327_109.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 55
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_111.png" src="../../_images/09_unsupervised_learning_327_111.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 56
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_113.png" src="../../_images/09_unsupervised_learning_327_113.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 57
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_115.png" src="../../_images/09_unsupervised_learning_327_115.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 58
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_117.png" src="../../_images/09_unsupervised_learning_327_117.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 59
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_119.png" src="../../_images/09_unsupervised_learning_327_119.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 60
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_121.png" src="../../_images/09_unsupervised_learning_327_121.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 61
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_123.png" src="../../_images/09_unsupervised_learning_327_123.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 62
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_125.png" src="../../_images/09_unsupervised_learning_327_125.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 63
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_127.png" src="../../_images/09_unsupervised_learning_327_127.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 64
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_129.png" src="../../_images/09_unsupervised_learning_327_129.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 65
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_131.png" src="../../_images/09_unsupervised_learning_327_131.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 66
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_133.png" src="../../_images/09_unsupervised_learning_327_133.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 67
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_135.png" src="../../_images/09_unsupervised_learning_327_135.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 68
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_137.png" src="../../_images/09_unsupervised_learning_327_137.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 69
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_139.png" src="../../_images/09_unsupervised_learning_327_139.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 70
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_141.png" src="../../_images/09_unsupervised_learning_327_141.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 71
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_143.png" src="../../_images/09_unsupervised_learning_327_143.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 72
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_145.png" src="../../_images/09_unsupervised_learning_327_145.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 73
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_147.png" src="../../_images/09_unsupervised_learning_327_147.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 74
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_149.png" src="../../_images/09_unsupervised_learning_327_149.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 75
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_151.png" src="../../_images/09_unsupervised_learning_327_151.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 76
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_153.png" src="../../_images/09_unsupervised_learning_327_153.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 77
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_155.png" src="../../_images/09_unsupervised_learning_327_155.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 78
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_157.png" src="../../_images/09_unsupervised_learning_327_157.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 79
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_159.png" src="../../_images/09_unsupervised_learning_327_159.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 80
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_161.png" src="../../_images/09_unsupervised_learning_327_161.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 81
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_163.png" src="../../_images/09_unsupervised_learning_327_163.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 82
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_165.png" src="../../_images/09_unsupervised_learning_327_165.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 83
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_167.png" src="../../_images/09_unsupervised_learning_327_167.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 84
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_169.png" src="../../_images/09_unsupervised_learning_327_169.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 85
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_171.png" src="../../_images/09_unsupervised_learning_327_171.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 86
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_173.png" src="../../_images/09_unsupervised_learning_327_173.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 87
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_175.png" src="../../_images/09_unsupervised_learning_327_175.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 88
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_177.png" src="../../_images/09_unsupervised_learning_327_177.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 89
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_179.png" src="../../_images/09_unsupervised_learning_327_179.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 90
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_181.png" src="../../_images/09_unsupervised_learning_327_181.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 91
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_183.png" src="../../_images/09_unsupervised_learning_327_183.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 92
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_185.png" src="../../_images/09_unsupervised_learning_327_185.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 93
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_187.png" src="../../_images/09_unsupervised_learning_327_187.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 94
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_189.png" src="../../_images/09_unsupervised_learning_327_189.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 95
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_191.png" src="../../_images/09_unsupervised_learning_327_191.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 96
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_193.png" src="../../_images/09_unsupervised_learning_327_193.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 97
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_195.png" src="../../_images/09_unsupervised_learning_327_195.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 98
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_197.png" src="../../_images/09_unsupervised_learning_327_197.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 99
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_199.png" src="../../_images/09_unsupervised_learning_327_199.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 100
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_201.png" src="../../_images/09_unsupervised_learning_327_201.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 101
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_203.png" src="../../_images/09_unsupervised_learning_327_203.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 102
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_205.png" src="../../_images/09_unsupervised_learning_327_205.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 103
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_207.png" src="../../_images/09_unsupervised_learning_327_207.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 104
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_209.png" src="../../_images/09_unsupervised_learning_327_209.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 105
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_211.png" src="../../_images/09_unsupervised_learning_327_211.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 106
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_213.png" src="../../_images/09_unsupervised_learning_327_213.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 107
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_215.png" src="../../_images/09_unsupervised_learning_327_215.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 108
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_217.png" src="../../_images/09_unsupervised_learning_327_217.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 109
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_219.png" src="../../_images/09_unsupervised_learning_327_219.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 110
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_221.png" src="../../_images/09_unsupervised_learning_327_221.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 111
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_223.png" src="../../_images/09_unsupervised_learning_327_223.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 112
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_225.png" src="../../_images/09_unsupervised_learning_327_225.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 113
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_227.png" src="../../_images/09_unsupervised_learning_327_227.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 114
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_229.png" src="../../_images/09_unsupervised_learning_327_229.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 115
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_231.png" src="../../_images/09_unsupervised_learning_327_231.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 116
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_233.png" src="../../_images/09_unsupervised_learning_327_233.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 117
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_235.png" src="../../_images/09_unsupervised_learning_327_235.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 118
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_237.png" src="../../_images/09_unsupervised_learning_327_237.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 119
</pre></div>
</div>
<img alt="../../_images/09_unsupervised_learning_327_239.png" src="../../_images/09_unsupervised_learning_327_239.png" />
</div>
</div>
<p>About 2 out of 3 clusters are useful: that is, they contain at least 2 pictures, all of the same person. However, the rest of the clusters have either one or more intruders, or they have just a single picture.</p>
<p>Clustering images this way may be too imprecise to be directly useful when training a model (as we will see below), but it can be tremendously useful when labeling images in a new dataset: it will usually make labelling much faster.</p>
</section>
<section id="using-clustering-as-preprocessing-for-classification">
<h2>11. Using Clustering as Preprocessing for Classification<a class="headerlink" href="#using-clustering-as-preprocessing-for-classification" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: Continuing with the Olivetti faces dataset, train a classifier to predict which person is represented in each picture, and evaluate it on the validation set.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.ensemble import RandomForestClassifier

clf = RandomForestClassifier(n_estimators=150, random_state=42)
clf.fit(X_train_pca, y_train)
clf.score(X_valid_pca, y_valid)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.925
</pre></div>
</div>
</div>
</div>
<p><em>Exercise: Next, use K-Means as a dimensionality reduction tool, and train a classifier on the reduced set.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train_reduced = best_model.transform(X_train_pca)
X_valid_reduced = best_model.transform(X_valid_pca)
X_test_reduced = best_model.transform(X_test_pca)

clf = RandomForestClassifier(n_estimators=150, random_state=42)
clf.fit(X_train_reduced, y_train)
    
clf.score(X_valid_reduced, y_valid)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7
</pre></div>
</div>
</div>
</div>
<p>Yikes! That’s not better at all! Let’s see if tuning the number of clusters helps.</p>
<p><em>Exercise: Search for the number of clusters that allows the classifier to get the best performance: what performance can you reach?</em></p>
<p>We could use a <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> like we did earlier in this notebook, but since we already have a validation set, we don’t need K-fold cross-validation, and we’re only exploring a single hyperparameter, so it’s simpler to just run a loop manually:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.pipeline import Pipeline

for n_clusters in k_range:
    pipeline = Pipeline([
        (&quot;kmeans&quot;, KMeans(n_clusters=n_clusters, random_state=42)),
        (&quot;forest_clf&quot;, RandomForestClassifier(n_estimators=150, random_state=42))
    ])
    pipeline.fit(X_train_pca, y_train)
    print(n_clusters, pipeline.score(X_valid_pca, y_valid))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5 0.3875
10 0.575
15 0.6
20 0.6625
25 0.6625
30 0.6625
35 0.675
40 0.75
45 0.7375
50 0.725
55 0.7125
60 0.7125
65 0.7375
70 0.7375
75 0.7375
80 0.7875
85 0.7625
90 0.75
95 0.7125
100 0.775
105 0.75
110 0.725
115 0.7625
120 0.7
125 0.75
130 0.725
135 0.7375
140 0.7625
145 0.6875
</pre></div>
</div>
</div>
</div>
<p>Oh well, even by tuning the number of clusters, we never get beyond 80% accuracy. Looks like the distances to the cluster centroids are not as informative as the original images.</p>
<p><em>Exercise: What if you append the features from the reduced set to the original features (again, searching for the best number of clusters)?</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train_extended = np.c_[X_train_pca, X_train_reduced]
X_valid_extended = np.c_[X_valid_pca, X_valid_reduced]
X_test_extended = np.c_[X_test_pca, X_test_reduced]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>clf = RandomForestClassifier(n_estimators=150, random_state=42)
clf.fit(X_train_extended, y_train)
clf.score(X_valid_extended, y_valid)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8125
</pre></div>
</div>
</div>
</div>
<p>That’s a bit better, but still worse than without the cluster features. The clusters are not useful to directly train a classifier in this case (but they can still help when labelling new training instances).</p>
</section>
<section id="a-gaussian-mixture-model-for-the-olivetti-faces-dataset">
<h2>12. A Gaussian Mixture Model for the Olivetti Faces Dataset<a class="headerlink" href="#a-gaussian-mixture-model-for-the-olivetti-faces-dataset" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: Train a Gaussian mixture model on the Olivetti faces dataset. To speed up the algorithm, you should probably reduce the dataset’s dimensionality (e.g., use PCA, preserving 99% of the variance).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.mixture import GaussianMixture

gm = GaussianMixture(n_components=40, random_state=42)
y_pred = gm.fit_predict(X_train_pca)
</pre></div>
</div>
</div>
</div>
<p><em>Exercise: Use the model to generate some new faces (using the <code class="docutils literal notranslate"><span class="pre">sample()</span></code> method), and visualize them (if you used PCA, you will need to use its <code class="docutils literal notranslate"><span class="pre">inverse_transform()</span></code> method).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_gen_faces = 20
gen_faces_reduced, y_gen_faces = gm.sample(n_samples=n_gen_faces)
gen_faces = pca.inverse_transform(gen_faces_reduced)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_faces(gen_faces, y_gen_faces)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_348_0.png" src="../../_images/09_unsupervised_learning_348_0.png" />
</div>
</div>
<p><em>Exercise: Try to modify some images (e.g., rotate, flip, darken) and see if the model can detect the anomalies (i.e., compare the output of the <code class="docutils literal notranslate"><span class="pre">score_samples()</span></code> method for normal images and for anomalies).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_rotated = 4
rotated = np.transpose(X_train[:n_rotated].reshape(-1, 64, 64), axes=[0, 2, 1])
rotated = rotated.reshape(-1, 64*64)
y_rotated = y_train[:n_rotated]

n_flipped = 3
flipped = X_train[:n_flipped].reshape(-1, 64, 64)[:, ::-1]
flipped = flipped.reshape(-1, 64*64)
y_flipped = y_train[:n_flipped]

n_darkened = 3
darkened = X_train[:n_darkened].copy()
darkened[:, 1:-1] *= 0.3
y_darkened = y_train[:n_darkened]

X_bad_faces = np.r_[rotated, flipped, darkened]
y_bad = np.concatenate([y_rotated, y_flipped, y_darkened])

plot_faces(X_bad_faces, y_bad)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_350_0.png" src="../../_images/09_unsupervised_learning_350_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_bad_faces_pca = pca.transform(X_bad_faces)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.score_samples(X_bad_faces_pca)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-2.43643267e+07, -1.89785012e+07, -3.78112367e+07, -4.98187629e+07,
       -3.20479020e+07, -1.37531267e+07, -2.92373870e+07, -1.05489069e+08,
       -1.19575421e+08, -6.74256883e+07])
</pre></div>
</div>
</div>
</div>
<p>The bad faces are all considered highly unlikely by the Gaussian Mixture model. Compare this to the scores of some training instances:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gm.score_samples(X_train_pca[:10])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1163.02020926, 1134.03637965, 1156.32132746, 1170.67602789,
       1141.45404798, 1154.352051  , 1091.32894399, 1111.4114952 ,
       1096.43049058, 1132.98982659])
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-dimensionality-reduction-techniques-for-anomaly-detection">
<h2>13. Using Dimensionality Reduction Techniques for Anomaly Detection<a class="headerlink" href="#using-dimensionality-reduction-techniques-for-anomaly-detection" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: Some dimensionality reduction techniques can also be used for anomaly detection. For example, take the Olivetti faces dataset and reduce it with PCA, preserving 99% of the variance. Then compute the reconstruction error for each image. Next, take some of the modified images you built in the previous exercise, and look at their reconstruction error: notice how much larger the reconstruction error is. If you plot a reconstructed image, you will see why: it tries to reconstruct a normal face.</em></p>
<p>We already reduced the dataset using PCA earlier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train_pca
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 3.78082728e+00, -1.85479510e+00, -5.14403820e+00, ...,
        -1.35639057e-01, -2.14079842e-01,  6.11891970e-02],
       [ 1.01488552e+01, -1.52754760e+00, -7.66972005e-01, ...,
         1.23932086e-01, -1.35267869e-01, -2.32773516e-02],
       [-1.00152864e+01,  2.87729192e+00, -9.19888794e-01, ...,
         7.26092011e-02, -2.96637439e-03,  1.24891117e-01],
       ...,
       [ 2.47586942e+00,  2.95597434e+00,  1.29985297e+00, ...,
        -2.09175814e-02,  3.48586701e-02, -1.54327601e-01],
       [-3.22031736e+00,  5.34898043e+00,  1.39426994e+00, ...,
         5.75454161e-02, -2.28316277e-01,  1.55572280e-01],
       [-9.22876596e-01, -3.64703155e+00,  2.26088214e+00, ...,
         1.36855245e-01, -6.91372752e-02,  6.26810342e-02]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def reconstruction_errors(pca, X):
    X_pca = pca.transform(X)
    X_reconstructed = pca.inverse_transform(X_pca)
    mse = np.square(X_reconstructed - X).mean(axis=-1)
    return mse
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reconstruction_errors(pca, X_train).mean()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0001920535
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reconstruction_errors(pca, X_bad_faces).mean()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.004707354
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_faces(X_bad_faces, y_bad)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_362_0.png" src="../../_images/09_unsupervised_learning_362_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_bad_faces_reconstructed = pca.inverse_transform(X_bad_faces_pca)
plot_faces(X_bad_faces_reconstructed, y_bad)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09_unsupervised_learning_363_0.png" src="../../_images/09_unsupervised_learning_363_0.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./handson-ml2/original"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="08_dimensionality_reduction.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Chapter 8 – Dimensionality Reduction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="10_neural_nets_with_keras.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 10 – Introduction to Artificial Neural Networks with Keras</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Daniel Kapitan<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>